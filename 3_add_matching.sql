-- 14/11/22 
ALTER TABLE ADD_IN COMPRESS;
--CHECK UNSEEDED IS DROPPED
CREATE TABLE UNSEEDED AS SELECT DISTINCT ID, CURRENT_LINE1, CURRENT_LINE2,CURRENT_LINE3,
H3_4_P,H3_6_P,H3_7_P,H3_8_P, H3_10_P,
ADD_STRING_WORKING,ADDRESS_STRING ,ADD_NUM,BUILD_NO,SUB_UNIT,NEIGHBOURS,NEAR_NEIGHBOURS,FAR_NEIGHBOURS,VFAR_NEIGHBOURS,
replace(ADD_STRING_WORKING,' ','') as ADD_NO_SPACE,
--regexp_substr(ADDRESS_STRING,'(LEVEL|LVL|FLOOR|FLR|UNIT|ROOM|RM|FLAT|FLT|APT|APPARTMENT|SUITE)+.*[[:digit:]]|[[:digit:]].*[[:digit:]][[:alpha:]]*|[[:digit:]]+') AS ADD_NUM,
WORD_ONE,WORD_TWO,WORD_THREE,WORD_FOUR,WORD_FIVE,WORD_SIX,WORD_ONE_M,WORD_TWO_M,WORD_THREE_M,WORD_FOUR_M,WORD_FIVE_M,WORD_SIX_M 
FROM ADD_IN ;

ALTER TABLE UNSEEDED COMPRESS;

CREATE INDEX H3_IN
ON UNSEEDED ( H3_4_P,
           H3_6_P,
           H3_7_P,
           H3_8_P,               
           H3_10_P);
--SECOND HALF OF RUN
--DELETE FROM UNSEEDED
--WHERE EXISTS( SELECT 1 FROM UPRNSEEDING_65_3 Where UNSEEDED.ID = UPRNSEEDING_65_3.ID);
--commit;

ALTER TABLE UNSEEDED ADD STAGE varchar(250);
------------------
--random selection
---------------------
--CREATE TABLE RANDOM AS SELECT * FROM UNSEEDED SAMPLE(1); --1% sample

--UPDATE UNSEEDED SET ADD_NUM = replace(UNSEEDED.ADD_NUM,'-', '/');
--------------------------
--INCOMING DATA CLEANING--
--------------------------
alter table UNSEEDED parallel 12;
commit;

ALTER TABLE UNSEEDED
ADD range_lower varchar(250);
ALTER TABLE UNSEEDED
ADD range_upper varchar(250);

UPDATE UNSEEDED SET range_LOWER =CAST(regexp_replace(regexp_substr(UNSEEDED.ADD_num, '[^/]+[0-9]', 1, 1), '[^0-9]','')AS INT);
UPDATE UNSEEDED SET range_upper =CAST(regexp_replace(regexp_substr(UNSEEDED.ADD_num, '[^/]+[0-9]', 1, 2), '[^0-9]','')AS INT);

ALTER TABLE UNSEEDED
ADD range_lower2 varchar(250);
ALTER TABLE UNSEEDED
ADD range_upper2 varchar(250);

UPDATE UNSEEDED SET BUILD_NO =Regexp_replace(UNSEEDED.BUILD_NO,'[/]','-');
UPDATE UNSEEDED SET range_LOWER2 =CAST(regexp_replace(regexp_substr(UNSEEDED.BUILD_NO, '[^- ]+[0-9]', 1, 1), '[^0-9]','')AS INT);
UPDATE UNSEEDED SET range_upper2 =CAST(regexp_replace(regexp_substr(UNSEEDED.BUILD_NO, '[^- ]+[0-9]', 1, 2), '[^0-9]','')AS INT);


--UPDATE UNSEEDED SET NUM = trim(leading FROM UNSEEDED.ADD_NUM);

UPDATE UNSEEDED SET CURRENT_LINE1 = regexp_replace(UNSEEDED.CURRENT_LINE1,' ROOM | FLAT | RM | FLT | FT | SUITE | BLOCK | C/O ', ' ');
UPDATE UNSEEDED SET ADDRESS_STRING = regexp_replace(UNSEEDED.ADDRESS_STRING,' ROOM | FLAT | RM | FLT | FT | SUITE | BLOCK | C/O ', ' ');
UPDATE UNSEEDED SET CURRENT_LINE1 = regexp_replace(UNSEEDED.CURRENT_LINE1,' CRT | CT ', ' COURT ');
UPDATE UNSEEDED SET ADDRESS_STRING = regexp_replace(UNSEEDED.ADDRESS_STRING,' CRT | CT ', ' COURT ');

UPDATE UNSEEDED SET CURRENT_LINE1 = regexp_replace(UNSEEDED.CURRENT_LINE1,' TCE  | TERR  | TER ', ' TERRACE ');
UPDATE UNSEEDED SET ADDRESS_STRING = regexp_replace(UNSEEDED.ADDRESS_STRING,' TCE | TERR | TER ', ' TERRACE ');

UPDATE UNSEEDED SET CURRENT_LINE1 = regexp_replace(UNSEEDED.CURRENT_LINE1,' GDNS ', ' GARDENS ');
UPDATE UNSEEDED SET ADDRESS_STRING = regexp_replace(UNSEEDED.ADDRESS_STRING,' GDNS ', ' GARDENS ');

UPDATE UNSEEDED SET CURRENT_LINE1 = regexp_replace(UNSEEDED.CURRENT_LINE1,' HSE ', ' HOUSE ');
UPDATE UNSEEDED SET ADDRESS_STRING = regexp_replace(UNSEEDED.ADDRESS_STRING,' HSE ', ' HOUSE ');

--UPDATE UNSEEDED SET ADD_NUM = regexp_substr(UNSEEDED.ADDRESS_STRING,'(LEVEL|LVL|FLOOR|FLR|UNIT|ROOM|RM|FLAT|FLT|APT|APPARTMENT|SUITE)+.*[[:digit:]]|[[:digit:]].*[[:digit:]][[:alpha:]]*|[[:digit:]]+');

--UPDATE UNSEEDED SET ADD_NUM = replace(UNSEEDED.add_num, '^[[:space:]]', '') ;
--UPDATE UNSEEDED SET ADD_NUM = trim(leading FROM UNSEEDED.add_num);
--UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'-', '/');

--UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,',', ' ');
--UPDATE UNSEEDED SET add_num = regexp_replace(UNSEEDED.add_num, '[[:space:]]{2,}', ' ') ;

--UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'[:space:]//[:space:]', '/');
--UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'//', '/');

UPDATE UNSEEDED SET ADDRESS_STRING = replace(UNSEEDED.ADDRESS_STRING,',', ' ');
UPDATE UNSEEDED SET CURRENT_LINE1 = replace(UNSEEDED.CURRENT_LINE1 ,',', ' ');
UPDATE UNSEEDED SET CURRENT_LINE2 = replace(UNSEEDED.CURRENT_LINE2,',', ' ');
UPDATE UNSEEDED SET CURRENT_LINE3 = replace(UNSEEDED.CURRENT_LINE3,',', ' ');

UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,',', ' ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'[:space:]/[:space:]', '/');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'/[:space:]', '/');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'[:space:]/', '/');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'0[:space:]/[:space:]R', '0/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'1[:space:]/[:space:]R', '1/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'2[:space:]/[:space:]R', '2/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'3[:space:]/[:space:]R', '3/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'4[:space:]/[:space:]R', '4/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'1[:space:]/[:space:]L', '1/1 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'2[:space:]/[:space:]L', '2/1 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'3[:space:]/[:space:]L', '3/1 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'4[:space:]/[:space:]L', '4/1 ');

UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'0/R ', '0/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'1/R ', '1/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'2/R ', '2/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'3/R ', '3/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'4/R ', '4/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'1/L ', '1/1 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'2/L ', '2/1 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'3/L ', '3/1 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'4/L ', '4/1 ');

UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'0[:space:]/[:space:]2 ', '0/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'0[:space:]/[:space:]1 ', '0/1 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'1[:space:]/[:space:]2 ', '1/2 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'1[:space:]/[:space:]1 ', '1/1 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'2[:space:]/[:space:]2 ', '2/2 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'2[:space:]/[:space:]1 ', '2/1 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'3[:space:]/[:space:]2 ', '3/2 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'3[:space:]/[:space:]1 ', '3/1 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'4[:space:]/[:space:]2 ', '4/2 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'4[:space:]/[:space:]1 ', '4/1 ');

UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'0 2 ', '0/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'0 1 ', '0/1 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'1 2 ', '1/2 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'1 1 ', '1/1 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'2 2 ', '2/2 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'2 1 ', '2/1 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'3 2 ', '3/2 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'3 1 ', '3/1 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'4 2 ', '4/2 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'4 1 ', '4/1 ');

UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'0F2 ', '0/2 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'0F1 ', '0/1 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'1F2 ', '1/2 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'1F1 ', '1/1 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'2F2 ', '2/2 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'2F1 ', '2/1 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'3F2 ', '3/2 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'3F1 ', '3/1 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'4F2 ', '4/2 '); 
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'4F1 ', '4/1 ');
UPDATE UNSEEDED SET add_num = replace(UNSEEDED.add_num,'G/', '0/');



--MATCHING LOGIC LINES 1 & 2 MATCH PRECISELY AND BOTH OBJECTS WITH H3_6 TILE MAX SCORE ACCEPTED 
--IMPROVEMENT CHECK IF DENSE RANKING
create table results as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  ad_base.post_town,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) 
 - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
 WHERE UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2=AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2 
 AND AD_BASE.H3_6=UNSEEDED.H3_6_p;
 
UPDATE RESULTS SET STAGE= '1';

CREATE TABLE RESULTSA AS SELECT DISTINCT ID, STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,post_town,SCORE1 FROM(
SELECT ID, STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,post_town,SCORE1,
       MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE
         FROM RESULTS)
   WHERE SCORE1=MAX_SCORE
 ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
 
ALTER TABLE RESULTSA COMPRESS;
 
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTSA Where UNSEEDED.ID = RESULTSA.ID);
commit;

drop table "RESULTS";


--MATCHING LOGIC = LINES 1 & 2 MATCH TO WITHin  0.85 JW SCORE AND BOTH OBJECTS WITH H3_10 TILE MAX SCORE ACCEPTED 
--ADDRESS NUMERICAL ELEMENTS MATCH ,STREET DESCRIPTION IS IN BOTH ADDRESS STRINGS
--SECOND QUERY USES STREET ABBR AND SAME LOGIC
--IMPROVEMENT CHECK IF H3_10 IS OPTIMAL CONSIDER SETTLEMENT LOGIC AND SUB QUERY FOR RURAL AREAS
create table results1I as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
  AD_BASE.UPRN,
   AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_nopc,
  AD_BASE.DESCRIPTION,
 (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) 
 - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
 WHERE 
 AD_BASE.H3_10=UNSEEDED.H3_10_p 
  AND AD_BASE.ADD_NUM = UNSEEDED.ADD_NUM
 AND instr(UNSEEDED.ADDRESS_STRING,AD_BASE.DESCRIPTION,1,1)>0
AND UTL_MATCH.JARO_WINKLER(UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2, AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2)>0.85;

UPDATE results1I SET STAGE= '1I'; 

create table RESULTS1II as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
  AD_BASE.UPRN,
   AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  AD_BASE.DESCRIPTION,
 (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2))-
 UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE 
AD_BASE.H3_10=UNSEEDED.H3_10_p 
AND AD_BASE.ADD_NUM = UNSEEDED.ADD_NUM
AND instr(UNSEEDED.ADDRESS_STRING,ad_base.ABBR_STREET1,1,1)>0
AND UTL_MATCH.JARO_WINKLER(UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2, AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2)>0.85; 

UPDATE results1II SET STAGE= '1II'; 


 CREATE TABLE RESULTS1 AS 
select * from results1I
union 
select * from results1II;
 
 --PICK HIGHEST SCORE ONLY and where str name is in addres string
CREATE TABLE RESULTS1A AS SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,description, MAX_SCORE FROM(
SELECT ID, STAGE, UPRN,PARENT_UPRN,ADDRESS_STRING,ADDRESS_STRING_NOPC,score1,description,
       MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE
   FROM RESULTS1)
   WHERE SCORE1 = MAX_SCORE and 
       instr(ADDRESS_STRING,description,1,1)>0
 ORDER BY ID, ADDRESS_STRING;

 ALTER TABLE RESULTS1A COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTS1A Where UNSEEDED.id = RESULTS1A.id);
COMMIT;
drop table "RESULTS1I";
drop table "RESULTS1II";

drop table "RESULTS1";

--soundex of first words match here adddresses contain no numerical elements 
--both are with a h3_7 tile and first 2 address strings are with 0.88 JW score of each other
--match selection of highest score and street description being present. 

create table results2 as SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_7=UNSEEDED.H3_7_p 
AND AD_BASE.ADD_NUM IS NULL
AND UNSEEDED.ADD_NUM IS NULL
AND LENGTH(UNSEEDED.CURRENT_LINE1)>3
AND SOUNDEX(regexp_substr(UNSEEDED.CURRENT_LINE1, '[A-Z ]+', 1, 1))=SOUNDEX(regexp_substr(ad_base.ADDRESS_LINE_1, '[A-Z ]+', 1, 1))
AND (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2)>0.88;

UPDATE results2 SET STAGE= '2'; 
--PICK BEST SCORE ONLY and street name is in the address string
 CREATE TABLE RESULTS2A AS SELECT DISTINCT ID, STAGE,UPRN, PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, DESCRIPTION,MAX_SCORE FROM(
SELECT ID, STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, DESCRIPTION, SCORE1,
       MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE
   FROM RESULTS2)
   WHERE SCORE1 = MAX_SCORE 
   and instr(ADDRESS_STRING,description,1,1)>0
 ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
 
 ALTER TABLE RESULTS2A COMPRESS;
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTS2A Where UNSEEDED.ID = RESULTS2A.ID);
COMMIT;
drop table "RESULTS2";
----Lines 1&2 match precisely max score accepted and where matches result in only one parent UPRN from rival options.
create table results3 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.POST_TOWN,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.POST_TOWN) as score,
  AD_BASE.ADDRESS_STRING_NOPC
FROM UNSEEDED,AD_BASE
 WHERE UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2=AD_BASE.ADDRESS_LINE_1||AD_BASE.POST_TOWN;
 
 UPDATE results3 SET STAGE= '2'; 

--max score and resultant matches have only a single parent UPRN amoungst them.
CREATE TABLE RESULTS3A AS SELECT DISTINCT ID, STAGE,UPRN,ADDRESS_STRING,PARENT_UPRN,ADDRESS_STRING_NOPC,SCORE, MAX_SCORE, COUNT_P_UPRN FROM(
SELECT ID, STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,
       MAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
       DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
   FROM RESULTS3)
   WHERE SCORE = MAX_SCORE AND COUNT_P_UPRN=1
 ORDER BY ID, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS3A COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTS3A Where UNSEEDED.ID = RESULTS3A.ID);
COMMIT;

drop table "RESULTS3";

--Numerical elements match, both entities within same h3_8 tile,lines 1& 2 and post town scored
--street name within both entities
create table results4 as SELECT DISTINCT
UNSEEDED.ID,UNSEEDED.STAGE,UNSEEDED.ADDRESS_STRING,UNSEEDED.CURRENT_LINE1,UNSEEDED.CURRENT_LINE2,
UNSEEDED.ADD_NUM as in_num,AD_BASE.ADD_NUM,   AD_BASE.UPRN,  AD_BASE.PARENT_UPRN,
  AD_BASE.DESCRIPTION,  AD_BASE.ADDRESS_LINE_1,  AD_BASE.ADDRESS_LINE_2,  AD_BASE.POST_TOWN,
  AD_BASE.ADDRESS_STRING_NOPC,
    (length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) 
    - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2||AD_BASE.POST_TOWN,TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2||AD_BASE.POST_TOWN) as score
FROM UNSEEDED,AD_BASE
WHERE UNSEEDED.H3_8_P=AD_BASE.H3_8
AND AD_BASE.ADD_NUM = UNSEEDED.ADD_NUM
AND (length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2||AD_BASE.POST_TOWN,TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2||AD_BASE.POST_TOWN)>0.85
  AND (INSTR(UNSEEDED.address_string ,AD_BASE.DESCRIPTION,1,1)>0 OR INSTR(UNSEEDED.address_string ,ad_base.ABBR_STREET1,1,1)>0);

UPDATE results4 SET STAGE= '4'; 

CREATE TABLE RESULTS4A AS SELECT DISTINCT ID,STAGE, UPRN, PARENT_UPRN,ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE, MAX_SCORE FROM(
SELECT ID,STAGE,UPRN, PARENT_UPRN,ADDRESS_STRING,  ADDRESS_STRING_NOPC, SCORE,
       MAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE
   FROM RESULTS4)
   WHERE SCORE = MAX_SCORE 
 ORDER BY ID, ADDRESS_STRING_NOPC;
 
 ALTER TABLE RESULTS4A COMPRESS;


DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTS4A Where UNSEEDED.ID = RESULTS4A.ID);
COMMIT;

drop table "RESULTS4";
----------------------------
--Both addresses are indexed to the same H3_7 tile, numerical elements match and line1 contains the street description.
----------------------------
create table results5 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,
TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))/length(AD_BASE.ADDRESS_STRING_NOPC) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
AND AD_BASE.ADD_NUM = UNSEEDED.ADD_NUM 
AND INSTR(UNSEEDED.CURRENT_LINE1 ,AD_BASE.description,1,1)>0;

UPDATE results5 SET STAGE= '5'; 

CREATE TABLE RESULTS5A AS SELECT DISTINCT ID, STAGE, UPRN, PARENT_UPRN,ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID, STAGE, UPRN, PARENT_UPRN,ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,
       MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE
   FROM RESULTS5)
   WHERE SCORE1 = MAX_SCORE
 ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS5A COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTS5A Where UNSEEDED.ID = RESULTS5A.ID);
COMMIT;

drop table "RESULTS5";
----------------------------------------
--both addresses are indexed to same h3_7 tile and street description is in any part of address string and numerical elements match
----------------------------------------
create table results6 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  (length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))
  /length(AD_BASE.ADDRESS_STRING_NOPC) as score,
  AD_BASE.ADDRESS_STRING_NOPC
  FROM UNSEEDED,AD_BASE
 WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
 AND INSTR(UNSEEDED.address_string ,AD_BASE.DESCRIPTION,1,1)>0
  AND AD_BASE.ADD_NUM = UNSEEDED.ADD_NUM;
  
UPDATE results6 SET STAGE= '6';   

CREATE TABLE RESULTS6A AS SELECT DISTINCT ID, STAGE,UPRN, PARENT_UPRN,ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE, MAX_SCORE FROM(
SELECT ID, STAGE, UPRN, PARENT_UPRN,ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,
       MAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE
   FROM RESULTS6)
   WHERE SCORE = MAX_SCORE
 ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS6A COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTS6A Where UNSEEDED.ID = RESULTS6A.ID);
COMMIT;
--
drop table "RESULTS6";
--both addresses indexed to the same h3_8 tile and line 1 contains str abbr or street description 
--and build no = incoming numbers or adbase buidl no is null and adbase sub_uit matches incoming numerical elements
create table results7 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  UTL_MATCH.edit_distance_similarity( AD_BASE.ADDRESS_STRING_NOPC,TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) as score1,
  AD_BASE.ADDRESS_STRING_NOPC
  FROM UNSEEDED,AD_BASE
 WHERE UNSEEDED.H3_8_P=AD_BASE.H3_8
 AND (INSTR(UNSEEDED.CURRENT_LINE1,ad_base.ABBR_STREET1,1,1)>0 OR INSTR(UNSEEDED.CURRENT_LINE1,AD_BASE.DESCRIPTION,1,1)>0)
 AND (AD_BASE.BUILD_NO=UNSEEDED.add_num OR AD_BASE.BUILD_NO IS NULL AND AD_BASE.SUB_UNIT = UNSEEDED.ADD_NUM);

UPDATE results7 SET STAGE= '7'; 

CREATE TABLE RESULTS7A AS SELECT DISTINCT ID, STAGE,UPRN, PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE, UPRN, PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,
       MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
       DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
   FROM RESULTS7)
   WHERE SCORE1 = MAX_SCORE AND COUNT_P_UPRN=1
 ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS7A COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTS7A Where UNSEEDED.ID = RESULTS7A.ID);
COMMIT;

drop table "RESULTS7";
--addresses are indexed to the same H3_7 tile andincoming line 3 is longer than 3 characters, 
--address string JW score diff is greater than 0.87 and ad_base buidlno is within incoming numerical elements.
create table results8 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
length( TRIM( LEADING ' ' FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,TRIM(LEADING ' ' FROM UNSEEDED.ADDRESS_STRING))/length(AD_BASE.ADDRESS_STRING_NOPC) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_7=UNSEEDED.H3_7_p
AND LENGTH(TRIM(UNSEEDED.CURRENT_LINE1))<3
and (length(TRIM(LEADING ' ' FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,TRIM(LEADING ' ' FROM UNSEEDED.ADDRESS_STRING)))/length(AD_BASE.ADDRESS_STRING_NOPC) >0.87
AND AD_BASE.BUILD_NO=UNSEEDED.BUILD_NO;

UPDATE results8 SET STAGE= '8'; 

CREATE TABLE RESULTS8A AS SELECT DISTINCT ID, STAGE,UPRN, PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE, COUNT_P_UPRN FROM(
SELECT ID, STAGE, UPRN, PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,
      MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
      DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
   FROM RESULTS8)
   WHERE SCORE1 = MAX_SCORE AND COUNT_P_UPRN =1
 ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS8A COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTS8A Where UNSEEDED.ID = RESULTS8A.ID);
COMMIT;
--
drop table "RESULTS8";

--addresses are indexed to the same h3_7 tile. addressbase build no is within incoming numerical elements street description is within incoming address 
--and JW score between full addressstrings is greater than 0.87

create table results9 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
(length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING))/length(AD_BASE.ADDRESS_STRING_NOPC)) AS SCORE1,
AD_BASE.ADDRESS_STRING_NOPC
FROM UNSEEDED,AD_BASE
WHERE UNSEEDED.H3_7_P=AD_BASE.H3_7
AND INSTR(UNSEEDED.ADDRESS_STRING,AD_BASE.DESCRIPTION,1,1)>0
AND AD_BASE.BUILD_NO=UNSEEDED.BUILD_NO
and (length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))/length(AD_BASE.ADDRESS_STRING_NOPC) >0.87;

 UPDATE results9 SET STAGE= '9'; 
 
 CREATE TABLE RESULTS9A AS SELECT DISTINCT ID,STAGE, UPRN, PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID, STAGE, UPRN, PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,
      MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE
   FROM RESULTS9)
   WHERE SCORE1 = MAX_SCORE
 ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS9A COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTS9A Where UNSEEDED.ID = RESULTS9A.ID);
COMMIT;
--
drop table "RESULTS9";
----------------------
--address is indexed to same H3_8 tile ad_base build_no = numerical elements form incoming lines 1 & 2 combined also contain the street desrciption from USRN.
----------------------
create table results10 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM,
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.description,
  (length(TRIM(LEADING FROM UNSEEDED.address_string)) - 
  UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,TRIM(LEADING FROM UNSEEDED.address_string)))/length(AD_BASE.ADDRESS_STRING_NOPC) AS SCORE1,
  AD_BASE.ADDRESS_STRING_NOPC
  FROM UNSEEDED,AD_BASE
WHERE UNSEEDED.H3_6_P=AD_BASE.H3_6
AND AD_BASE.BUILD_NO=UNSEEDED.BUILD_NO
AND INSTR(UNSEEDED.ADDRESS_STRING,AD_BASE.ABBR_STREET1,1,1)>0;

 UPDATE results10 SET STAGE= '10'; 

CREATE TABLE RESULTS10A AS SELECT DISTINCT ID, STAGE, UPRN, PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN, PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS10)
WHERE COUNT_P_UPRN=1 and SCORE1 >0.1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
--
 ALTER TABLE RESULTS10A COMPRESS;
 
drop table "RESULTS10";
--
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTS10A Where UNSEEDED.ID = RESULTS10A.ID);
COMMIT;

-------------------------
--addresses indexed to same h3_6 tile, address base build no = incoming numerical elements and street description is within line 1 from address
-------------------------
create table results11 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,
  TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))/length(AD_BASE.ADDRESS_STRING_NOPC) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_6=UNSEEDED.H3_6_P
AND AD_BASE.BUILD_NO = UNSEEDED.ADD_NUM 
AND INSTR(UNSEEDED.CURRENT_LINE1 ,AD_BASE.DESCRIPTION,1,1)>0;

 UPDATE results11 SET STAGE= '11'; 
--
CREATE TABLE RESULTS11A AS SELECT DISTINCT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE
FROM RESULTS11)
WHERE SCORE1 = MAX_SCORE 
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS11A COMPRESS;
--
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTS11A Where UNSEEDED.ID = RESULTS11A.ID);
COMMIT;
drop table "RESULTS11";
------------------------
--addresses indexed to the same H3_7 all numeric elements match line 2 contains teh street name or abbr of street name
------------------------
create table results12 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,
  TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))/length(AD_BASE.ADDRESS_STRING_NOPC) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
AND (AD_BASE.add_num= UNSEEDED.ADD_NUM )
AND (INSTR(UNSEEDED.CURRENT_LINE2 ,AD_BASE.DESCRIPTION,1,1)>0 or INSTR(UNSEEDED.CURRENT_LINE2 ,ad_base.ABBR_STREET1,1,1)>0);
--
 UPDATE results12 SET STAGE= '12'; 

CREATE TABLE RESULTS12A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE
FROM RESULTS12)
WHERE SCORE1 = MAX_SCORE 
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS12A COMPRESS;
--
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS12A Where UNSEEDED.ID = RESULTS12A.ID);
COMMIT;
drop table "RESULTS12";
-----------------
-- addresses are  indexed to same h3_7 tile build no = incoming numerical elements line 1 contains str abbr
-----------------
create table results13 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,
TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))/length(AD_BASE.ADDRESS_STRING_NOPC) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
AND(AD_BASE.BUILD_NO = UNSEEDED.ADD_NUM )
AND INSTR(UNSEEDED.CURRENT_LINE1 ,ad_base.ABBR_STREET1,1,1)>0;

UPDATE results13 SET STAGE= '13'; 

CREATE TABLE RESULTS13A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS13)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS13A 
COMPRESS;
--
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS13A Where UNSEEDED.ID = RESULTS13A.ID);
COMMIT;
drop table "RESULTS13";
-------------------
-------------------

-----------------
--addresses are indexed to same h3_7 numerical elements match and line 2 contains abbr street
-----------------
create table results14 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,
TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))/length(AD_BASE.ADDRESS_STRING_NOPC) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
AND (AD_BASE.ADD_NUM = UNSEEDED.ADD_NUM )
AND INSTR(UNSEEDED.CURRENT_LINE2 ,ad_base.ABBR_STREET1,1,1)>0;

 UPDATE results14 SET STAGE= '14'; 

CREATE TABLE RESULTS14A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS14)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS14A 
COMPRESS;
--
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS14A Where UNSEEDED.ID = RESULTS14A.ID);
COMMIT;
drop table "RESULTS14";
-----------------------------
--addresses are indexed to same h3_8 tile numerical elements match, line 1 and 2 with no white space are JW scored and threasholded to 0.8 in addtion street or str abbr are in the incoming address
-----------------------------
create table results15 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1)) - UTL_MATCH.JARO_WINKLER(AD_BASE.DESCRIPTION,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1)))/length(AD_BASE.DESCRIPTION) AS SCORE1,
(length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.JARO_WINKLER(AD_BASE.DESCRIPTION,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE2)))/length(AD_BASE.DESCRIPTION) AS SCORE2
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_8=UNSEEDED.H3_8_P
AND AD_BASE.ADD_NUM = UNSEEDED.ADD_NUM 
and UTL_MATCH.JARO_WINKLER(replace (UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2, ' ', ''),replace(ad_base.address_line_1||ad_base.address_line_2, ' ', ''))>0.8
AND (INSTR(UNSEEDED.CURRENT_LINE2,AD_BASE.DESCRIPTION, 1, 1)>0 OR INSTR(UNSEEDED.CURRENT_LINE2,ad_base.ABBR_STREET1, 1, 1)>0
OR INSTR(UNSEEDED.CURRENT_LINE1,AD_BASE.DESCRIPTION, 1, 1)>0 OR INSTR(UNSEEDED.CURRENT_LINE1,ad_base.ABBR_STREET1, 1, 1)>0);

UPDATE RESULTS15 SET STAGE= '15'; 
---------------------------------
CREATE TABLE RESULTS15A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE
FROM RESULTS15)
WHERE SCORE1 = MAX_SCORE 
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS15A COMPRESS;
-----------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS15A Where UNSEEDED.ID = RESULTS15A.ID);
COMMIT;
drop table "RESULTS15";
------------------------------------
--addresses indexed to same h3_7 tile numerical elements match, street and post town are within the address string, line 1 adn 2 JW dist is above 0.87 
------------------------------------
create table results16 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.CURRENT_LINE1,
UNSEEDED.CURRENT_LINE2,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
AD_BASE.ADDRESS_LINE_1,
AD_BASE.ADDRESS_LINE_2,
AD_BASE.POST_TOWN,
AD_BASE.TOWN,
AD_BASE.LOCALITY,
(length(UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.JARO_WINKLER(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)/length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE UNSEEDED.H3_7_P =AD_BASE.H3_7
AND AD_BASE.ADD_NUM = UNSEEDED.ADD_NUM 
AND (INSTR(UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2,ad_base.ABBR_STREET1, 1, 1)>0 or INSTR(UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2,AD_BASE.description, 1, 1)>0  )
AND INSTR(UNSEEDED.ADDRESS_STRING, AD_BASE.POST_TOWN, 1, 1)>0
and (length( UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2) - UTL_MATCH.JARO_WINKLER(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2))
/length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2)<0.87;
--AND SOUNDEX(regexp_substr(UNSEEDED.CURRENT_LINE2, '[A-Z ]+', 1, 1)) = SOUNDEX(regexp_substr(AD_BASE.DESCRIPTION, '[A-Z ]+', 1, 1));
-------------------
 UPDATE RESULTS16 SET STAGE= '16'; 

CREATE TABLE RESULTS16A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MIN_SCORE FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MIN(SCORE1) OVER (PARTITION BY ID) AS MIN_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS16)
WHERE COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS16A COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS16A Where UNSEEDED.ID = RESULTS16A.ID);
COMMIT;
drop table "RESULTS16";
--------------------------
--Addresses are indexed to h3_7 
--------------------------
create table results17I as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'BLOCK|FLAT|FLOOR FLAT',''),TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING))) / LENGTH(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'BLOCK|FLAT|FLOOR FLAT','')) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
AND AD_BASE.ADD_NUM = UNSEEDED.ADD_NUM
AND( INSTR(UNSEEDED.CURRENT_LINE2 ,ad_base.ABBR_STREET1,1,1)>0 OR INSTR(UNSEEDED.CURRENT_LINE1 ,ad_base.ABBR_STREET1,1,1)>0)
--OR  INSTR(UNSEEDED.CURRENT_LINE2 ,AD_BASE.DESCRIPTION,1,1)>0 OR INSTR(UNSEEDED.CURRENT_LINE1 ,AD_BASE.DESCRIPTION,1,1)>0)
and instr(UNSEEDED.ADDRESS_STRING,ad_base.post_town,1,1)>0;

UPDATE RESULTS17I SET STAGE= '17I'; 
 
create table results17II as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'BLOCK|FLAT|FLOOR FLAT',''),TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING))) / LENGTH(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'BLOCK|FLAT|FLOOR FLAT','')) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
AND AD_BASE.ADD_NUM = UNSEEDED.ADD_NUM
AND( INSTR(UNSEEDED.CURRENT_LINE2 ,AD_BASE.DESCRIPTION,1,1)>0 OR INSTR(UNSEEDED.CURRENT_LINE1 ,AD_BASE.DESCRIPTION,1,1)>0)
and instr(UNSEEDED.ADDRESS_STRING,ad_base.post_town,1,1)>0;

UPDATE RESULTS17II SET STAGE= '17II'; 
 
CREATE TABLE RESULTS17 AS 
select * from results17I
union 
select * from results17II;

----------------------------
CREATE TABLE RESULTS17A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MIN_SCORE FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MIN(SCORE1) OVER (PARTITION BY ID) AS MIN_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS17)
WHERE COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
------------------------
ALTER TABLE RESULTS17A COMPRESS;
------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS17A Where UNSEEDED.ID = RESULTS17A.ID);

COMMIT;
drop table "RESULTS17";
drop table "RESULTS17I";
drop table "RESULTS17II";
----------------------------
create table results18 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING))) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING))/length(AD_BASE.ADDRESS_STRING_NOPC) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_8=UNSEEDED.H3_8_P
AND  UNSEEDED.ADD_NO_SPACE = REPLACE(AD_BASE.ADDRESS_STRING_NOPC,' ','');
--------------------
UPDATE RESULTS18 SET STAGE= '18'; 

CREATE TABLE RESULTS18A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MIN_SCORE FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MIN(SCORE1) OVER (PARTITION BY ID) AS MIN_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS18)
WHERE COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
--------------------
ALTER TABLE RESULTS18A COMPRESS;
-------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS18A Where UNSEEDED.ID = RESULTS18A.ID);
COMMIT;
---------------------
drop table "RESULTS18";
-----------------
--------------------
create table results19 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|FLOOR|RM|ROOM|FLAT','')||AD_BASE.ADDRESS_LINE_2
,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/
length(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|RM|ROOM|FLOOR|FLAT','')||AD_BASE.ADDRESS_LINE_2) AS SCORE1
FROM UNSEEDED,AD_BASE
 WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
AND INSTR(UNSEEDED.ADDRESS_STRING ,ad_base.ABBR_STREET1,1,1)>0
AND INSTR(UNSEEDED.ADDRESS_STRING ,AD_BASE.POST_TOWN,1,1)>0
AND UNSEEDED.add_num=AD_BASE.add_num;

UPDATE RESULTS19 SET STAGE= '19'; 

CREATE TABLE RESULTS19A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE
FROM RESULTS19)
WHERE SCORE1 = MAX_SCORE 
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
------------------------
ALTER TABLE RESULTS19A COMPRESS;
---------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS19A Where UNSEEDED.ID = RESULTS19A.ID);
COMMIT;
drop table "RESULTS19";
-----------------------
create table results20 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|FLOOR|RM|ROOM|FLAT','')||AD_BASE.ADDRESS_LINE_2
  ,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/length(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|RM|ROOM|FLOOR|FLAT','')||AD_BASE.ADDRESS_LINE_2) AS SCORE1
FROM UNSEEDED,AD_BASE
 WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
 AND  INSTR(UNSEEDED.CURRENT_LINE2 ,AD_BASE.DESCRIPTION,1,1)>0
AND UNSEEDED.CURRENT_LINE3=AD_BASE.POST_TOWN
AND UNSEEDED.add_num=AD_BASE.add_num ;
------------
UPDATE RESULTS20 SET STAGE= '20'; 

CREATE TABLE RESULTS20A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
COUNT(DISTINCT PARENT_UPRN) OVER (PARTITION BY ID) AS COUNT_P_UPRN
FROM RESULTS20)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
----------------
ALTER TABLE RESULTS20A
COMPRESS;
--------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS20A Where UNSEEDED.ID = RESULTS20A.ID);
COMMIT;
drop table "RESULTS20";
-------------
----------
create table results21 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.description,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|FLOOR|RM|ROOM|FLAT','')||AD_BASE.ADDRESS_LINE_2
,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/length(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|RM|ROOM|FLOOR|FLAT','')||AD_BASE.ADDRESS_LINE_2) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_8=UNSEEDED.H3_8_P
and ad_base.ABBR_STREET1 is not null
AND  INSTR(UNSEEDED.CURRENT_LINE2 ,ad_base.ABBR_STREET1,1,1)>0
AND UNSEEDED.CURRENT_LINE3=AD_BASE.POST_TOWN
AND UNSEEDED.BUILD_NO = AD_BASE.BUILD_NO;

UPDATE RESULTS21 SET STAGE= '21'; 
-----------------------
CREATE TABLE RESULTS21A AS SELECT DISTINCT ID,stage, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID, stage, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
COUNT(DISTINCT PARENT_UPRN) OVER (PARTITION BY ID) AS COUNT_P_UPRN
FROM RESULTS21)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
----------------------
ALTER TABLE RESULTS21A COMPRESS;
----------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS21A Where UNSEEDED.ID = RESULTS21A.ID);
COMMIT;
---------------------
drop table "RESULTS21";
-----------------
----------------------
create table results22 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.description,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|FLOOR|RM|ROOM|FLAT','')||AD_BASE.ADDRESS_LINE_2
,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/
length(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|RM|ROOM|FLOOR|FLAT','')||AD_BASE.ADDRESS_LINE_2) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_8=UNSEEDED.H3_8_P
and ad_base.ABBR_STREET1 is not null
AND  INSTR(UNSEEDED.CURRENT_LINE2 ,ad_base.ABBR_STREET1,1,1)>0
AND UNSEEDED.BUILD_NO = AD_BASE.BUILD_NO;
---------------------------------------
UPDATE RESULTS22 SET STAGE= '22'; 

CREATE TABLE RESULTS22A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
COUNT(DISTINCT PARENT_UPRN) OVER (PARTITION BY ID) AS COUNT_P_UPRN
FROM RESULTS22)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
---------------------------------------
ALTER TABLE RESULTS22A COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS22A Where UNSEEDED.ID = RESULTS22A.ID);
COMMIT;
---------------------------------------
drop table "RESULTS22";
-----------------
create table results23 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.description,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|FLOOR|RM|ROOM|FLAT','')||AD_BASE.ADDRESS_LINE_2
,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/
length(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|RM|ROOM|FLOOR|FLAT','')||AD_BASE.ADDRESS_LINE_2) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_8=UNSEEDED.H3_8_P
and ad_base.ABBR_STREET1 is not null
AND  INSTR(UNSEEDED.CURRENT_LINE1 ,ad_base.ABBR_STREET1,1,1)>0
AND UNSEEDED.BUILD_NO = AD_BASE.BUILD_NO;
---------------------------------------
UPDATE RESULTS23 SET STAGE= '23';

CREATE TABLE RESULTS23A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
COUNT(DISTINCT PARENT_UPRN) OVER (PARTITION BY ID) AS COUNT_P_UPRN
FROM RESULTS23)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
---------------------------------------
ALTER TABLE RESULTS23A
COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS23A Where UNSEEDED.ID = RESULTS23A.ID);
COMMIT;
drop table "RESULTS23";
---------------------------------------
create table results24 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.description,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|FLOOR|RM|ROOM|FLAT','')||AD_BASE.ADDRESS_LINE_2
,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/length(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|RM|ROOM|FLOOR|FLAT','')||AD_BASE.ADDRESS_LINE_2) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
--and ad_base.ABBR_STREET1is not null
AND UNSEEDED.add_NUM = AD_BASE.sub_unit
AND  (INSTR(UNSEEDED.ADDRESS_STRING ,ad_base.ABBR_STREET1,1,1)>0 or INSTR(UNSEEDED.ADDRESS_STRING ,AD_BASE.description,1,1)>0);

UPDATE RESULTS24 SET STAGE= '24';
--OR UNSEEDED.ADD_NUM = AD_BASE.ADD_NUM);
---------------------------------------
CREATE TABLE RESULTS24A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID, STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
COUNT(DISTINCT PARENT_UPRN) OVER (PARTITION BY ID) AS COUNT_P_UPRN
FROM RESULTS24)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
---------------------------------------
ALTER TABLE RESULTS24A COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS24A Where UNSEEDED.ID = RESULTS24A.ID);
COMMIT;
---------------------------------------
drop table "RESULTS24";
---------------------------------------
---------------------------------------
create table results25 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.description,
AD_BASE.ADDRESS_STRING_NOPC,
AD_BASE.BUILD_NO,
AD_BASE.SUB_UNIT,
(length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|FLOOR|RM|ROOM|FLAT','')||AD_BASE.ADDRESS_LINE_2
,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/
length(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|RM|ROOM|FLOOR|FLAT','')||AD_BASE.ADDRESS_LINE_2) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
and AD_BASE.DESCRIPTION is not null
AND  (INSTR(UNSEEDED.CURRENT_LINE1 ,AD_BASE.DESCRIPTION,1,1)>0 or INSTR(UNSEEDED.CURRENT_LINE1 ,ad_base.ABBR_STREET1,1,1)>0 )
AND INSTR(UNSEEDED.ADDRESS_STRING ,AD_BASE.BUILD_NO,1,1)>0
AND INSTR(UNSEEDED.ADDRESS_STRING ,AD_BASE.SUB_UNIT,1,1)>0
and (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|FLOOR|RM|ROOM|FLAT','')||AD_BASE.ADDRESS_LINE_2
,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/
length(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|RM|ROOM|FLOOR|FLAT','')||AD_BASE.ADDRESS_LINE_2)>0.75;
UPDATE RESULTS25 SET STAGE= '25';
---------------------------------------
CREATE TABLE RESULTS25A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
COUNT(DISTINCT PARENT_UPRN) OVER (PARTITION BY ID) AS COUNT_P_UPRN
FROM RESULTS25)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
---------------------------------------
ALTER TABLE RESULTS25A COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS25A Where UNSEEDED.ID = RESULTS25A.ID);
COMMIT;
---------------------------------------
drop table "RESULTS25";
---------------------------------------
---------------------------------------
create table results26 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.description,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|FLOOR|RM|ROOM|FLAT','')||AD_BASE.ADDRESS_LINE_2
,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/
length(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|RM|ROOM|FLOOR|FLAT','')||AD_BASE.ADDRESS_LINE_2) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
and AD_BASE.DESCRIPTION is not null
AND  (INSTR(UNSEEDED.CURRENT_LINE1 ,AD_BASE.DESCRIPTION,1,1)>0 or INSTR(UNSEEDED.CURRENT_LINE1 ,ad_base.ABBR_STREET1,1,1)>0)
AND UNSEEDED.BUILD_NO = AD_BASE.BUILD_NO;

UPDATE RESULTS26 SET STAGE= '26';
---------------------------------------
CREATE TABLE RESULTS26A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID, STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
COUNT(DISTINCT PARENT_UPRN) OVER (PARTITION BY ID) AS COUNT_P_UPRN
FROM RESULTS26)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
---------------------------------------
ALTER TABLE RESULTS26A
COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS26A Where UNSEEDED.ID = RESULTS26A.ID);
COMMIT;
drop table "RESULTS26";
---------------------------------------
---------------------------------------
create table results27 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.description,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|FLOOR|RM|ROOM|FLAT','')||AD_BASE.ADDRESS_LINE_2
,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/length(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|RM|ROOM|FLOOR|FLAT','')||AD_BASE.ADDRESS_LINE_2) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
and AD_BASE.DESCRIPTION is not null
AND (INSTR(UNSEEDED.CURRENT_LINE2 ,AD_BASE.DESCRIPTION,1,1)>0 or INSTR(UNSEEDED.CURRENT_LINE2 ,ad_base.ABBR_STREET1,1,1)>0)
AND UNSEEDED.BUILD_NO = AD_BASE.BUILD_NO;

UPDATE RESULTS27 SET STAGE= '27';
---------------------------------------
CREATE TABLE RESULTS27A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
COUNT(DISTINCT PARENT_UPRN) OVER (PARTITION BY ID) AS COUNT_P_UPRN
FROM RESULTS27)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
---------------------------------------
ALTER TABLE RESULTS27A COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS27A Where UNSEEDED.ID = RESULTS27A.ID);
COMMIT;
drop table "RESULTS27";
---------------------------------------
---------------------------------------
create table results28 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
UNSEEDED.BUILD_NO as in_B_NO,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.description,
AD_BASE.BUILD_NO AS B_NO,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|FLOOR|RM|ROOM|FLAT','')||AD_BASE.ADDRESS_LINE_2
,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/
length(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|RM|ROOM|FLOOR|FLAT','')||AD_BASE.ADDRESS_LINE_2) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_6=UNSEEDED.H3_6_P
and AD_BASE.DESCRIPTION is not null
AND  (INSTR(UNSEEDED.CURRENT_LINE1 ,AD_BASE.DESCRIPTION,1,1)>0 or INSTR(UNSEEDED.CURRENT_LINE1 ,ad_base.ABBR_STREET1,1,1)>0
OR INSTR(UNSEEDED.CURRENT_LINE2 ,AD_BASE.DESCRIPTION,1,1)>0 or INSTR(UNSEEDED.CURRENT_LINE2 ,ad_base.ABBR_STREET1,1,1)>0)
AND UNSEEDED.BUILD_NO = AD_BASE.BUILD_NO;
---------------------------------------
UPDATE RESULTS28 SET STAGE= '28';

CREATE TABLE RESULTS28A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN,B_NO,IN_B_NO, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,B_NO,IN_B_NO,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
COUNT(DISTINCT PARENT_UPRN) OVER (PARTITION BY ID) AS COUNT_P_UPRN
FROM RESULTS28)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
AND B_NO=IN_B_NO
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
---------------------------------------
ALTER TABLE RESULTS28A
COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS28A Where UNSEEDED.ID = RESULTS28A.ID);
COMMIT;
drop table "RESULTS28";
---------------------------------------

---------------------------------------
create table results29 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
UNSEEDED.BUILD_NO as in_B_NO,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.description,
AD_BASE.BUILD_NO AS B_NO,
AD_BASE.ADDRESS_STRING_NOPC,
(length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
UTL_MATCH.EDIT_DISTANCE(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|FLOOR|RM|ROOM|FLAT','')||AD_BASE.ADDRESS_LINE_2
,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))/
length(regexp_replace(AD_BASE.ADDRESS_LINE_1,'UNIT|BLOCK|BLK|FLAT|FL|RM|ROOM|FLOOR|FLAT','')||AD_BASE.ADDRESS_LINE_2) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_6=UNSEEDED.H3_6_P
and AD_BASE.DESCRIPTION is not null
AND  (INSTR(UNSEEDED.CURRENT_LINE1 ,AD_BASE.DESCRIPTION,1,1)>0 or INSTR(UNSEEDED.CURRENT_LINE1 ,ad_base.ABBR_STREET1,1,1)>0
OR INSTR(UNSEEDED.CURRENT_LINE2 ,AD_BASE.DESCRIPTION,1,1)>0 or INSTR(UNSEEDED.CURRENT_LINE2 ,ad_base.ABBR_STREET1,1,1)>0)
AND UNSEEDED.BUILD_NO IS NULL
AND UNSEEDED.SUB_UNIT = AD_BASE.BUILD_NO;

UPDATE RESULTS29 SET STAGE= '29';
---------------------------------------
CREATE TABLE RESULTS29A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN,B_NO,IN_B_NO, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,B_NO,IN_B_NO,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
COUNT(DISTINCT PARENT_UPRN) OVER (PARTITION BY ID) AS COUNT_P_UPRN
FROM RESULTS29)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
---------------------------------------
ALTER TABLE RESULTS29A
COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS29A Where UNSEEDED.ID = RESULTS29A.ID);
COMMIT;
drop table "RESULTS29";
----------------------
-----------------------
create table results30 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
  AD_BASE.UPRN,
  PARENT_UPRN,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
  UTL_MATCH.JARO_WINKLER(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,
  TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_STRING_NOPC) as score1,
  AD_BASE.ADDRESS_STRING_NOPC
  FROM UNSEEDED,AD_BASE
 WHERE AD_BASE.H3_6=UNSEEDED.H3_6_P
 AND INSTR(UNSEEDED.CURRENT_LINE1 ,ad_base.ABBR_STREET1,1,1)>0
 AND INSTR(UNSEEDED.CURRENT_LINE2 ,AD_BASE.TOWN,1,1)>0
  AND AD_BASE.ADD_NUM = UNSEEDED.ADD_NUM;
  
  UPDATE RESULTS30 SET STAGE= '30';
-------------
CREATE TABLE RESULTS30A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN,ADDRESS_STRING,ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS30)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS30A COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS30A Where UNSEEDED.ID = RESULTS30A.ID);
COMMIT;

drop table "RESULTS30";
---------------------------------------
create table results31 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
  AD_BASE.UPRN,
  PARENT_UPRN,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.JARO_WINKLER(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_STRING_NOPC) as score,
  AD_BASE.ADDRESS_STRING_NOPC
  FROM UNSEEDED,AD_BASE
 WHERE AD_BASE.H3_6=UNSEEDED.H3_6_P
 AND INSTR(UNSEEDED.CURRENT_LINE1 ,ad_base.ABBR_STREET1,1,1)>0
 AND INSTR(UNSEEDED.CURRENT_LINE2 ,AD_BASE.TOWN,1,1)>0
  AND AD_BASE.BUILD_NO = UNSEEDED.SUB_UNIT
  AND UNSEEDED.BUILD_NO IS NULL;
  
UPDATE RESULTS31 SET STAGE= '31';
-------------
CREATE TABLE RESULTS31A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE, MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,MAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS31)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS31A COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS31A Where UNSEEDED.ID = RESULTS31A.ID);
COMMIT;
drop table "RESULTS31";
---------------------------------------

create table results32 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
UNSEEDED.CURRENT_LINE2,
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_LINE_2,
  (length(TRIM(UNSEEDED.SUB_UNIT||' '|| UNSEEDED.CURRENT_LINE2)) - SYS.UTL_MATCH.JARO_WINKLER_SIMILARITY(AD_BASE.ADD_NUM|| ' '||ad_base.ABBR_STREET1,TRIM(UNSEEDED.SUB_UNIT||' '|| UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADD_NUM|| ' '||ad_base.ABBR_STREET1) as score,
  AD_BASE.ADDRESS_STRING_NOPC
  FROM UNSEEDED,AD_BASE
 WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
and regexp_replace(regexp_replace(UNSEEDED.CURRENT_LINE2,'[A-Z]',''),'[[:space:]]{2,}', '')=AD_BASE.SUB_UNIT 
AND AD_BASE.BUILD_NO IS NULL
--and ad_base.ABBR_STREET1is not null
--NEEDS WORK ON SCORING AND TO ENSURE LINE 2 IS SIMILAR
 AND INSTR(UNSEEDED.CURRENT_LINE2 ,ad_base.ABBR_STREET1,1,1)>0;
 --------------------
 UPDATE RESULTS32 SET STAGE= '32';
 --------------------
CREATE TABLE RESULTS32A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE, MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,MAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS32)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS32A
COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS32A Where UNSEEDED.ID = RESULTS32A.ID);
COMMIT;
drop table "RESULTS32";

---------------------------------------
create table results33 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
UNSEEDED.CURRENT_LINE1,
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_LINE_1,
  (length(TRIM(UNSEEDED.CURRENT_LINE1)) 
  - SYS.UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADD_NUM|| ' '||ad_base.ABBR_STREET1,TRIM(UNSEEDED.CURRENT_LINE1)))
  /length(AD_BASE.ADD_NUM|| ' '||ad_base.ABBR_STREET1) as score,
  AD_BASE.ADDRESS_STRING_NOPC
  FROM UNSEEDED,AD_BASE
 WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
and regexp_replace(TRIM(regexp_replace(UNSEEDED.CURRENT_LINE1,'[A-Z]','')),'[[:space:]]{2,}', '')=AD_BASE.SUB_UNIT --problem here for alpha numbers
AND AD_BASE.BUILD_NO IS NULL
AND LENGTH(UNSEEDED.CURRENT_LINE1)>4
--NEEDS WORK ON SCORING AND TO ENSURE LINE 2 IS SIMILAR
 AND INSTR(UNSEEDED.CURRENT_LINE1,ad_base.ABBR_STREET1,1,1)>0;
 --------------------
 UPDATE RESULTS33 SET STAGE= '33';
 --------------------
 CREATE TABLE RESULTS33A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE, MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,MAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS33)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS33A
COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS33A Where UNSEEDED.ID = RESULTS33A.ID);
COMMIT;
drop table "RESULTS33";
---------------------------------------
create table results34 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
UNSEEDED.CURRENT_LINE1,
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_LINE_1,
  (length(TRIM(UNSEEDED.CURRENT_LINE1)) 
  - SYS.UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADD_NUM|| ' '||ad_base.ABBR_STREET1,TRIM(UNSEEDED.CURRENT_LINE1)))
  /length(AD_BASE.ADD_NUM|| ' '||ad_base.ABBR_STREET1) as score,
  AD_BASE.ADDRESS_STRING_NOPC
  FROM UNSEEDED,AD_BASE
 WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
and regexp_replace(TRIM(regexp_replace(UNSEEDED.CURRENT_LINE1,'[A-Z]','')),'[[:space:]]{2,}', '')=AD_BASE.SUB_UNIT --problem for alpha characters here
AND AD_BASE.BUILD_NO IS NULL
AND LENGTH(UNSEEDED.CURRENT_LINE1)>4
--NEEDS WORK ON SCORING AND TO ENSURE LINE 2 IS SIMILAR
 AND INSTR(UNSEEDED.CURRENT_LINE1,AD_BASE.DESCRIPTION ,1,1)>0 ;
 
--------------------
UPDATE RESULTS34 SET STAGE= '34';
 --------------------
 CREATE TABLE RESULTS34A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE, MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,MAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS34)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS34A
COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS34A Where UNSEEDED.ID = RESULTS34A.ID);
COMMIT;
drop table "RESULTS34";
--------------------------
-------------------------
create table results35 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
UNSEEDED.CURRENT_LINE1,
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_LINE_1,
  (length(TRIM(UNSEEDED.CURRENT_LINE1)) 
  - SYS.UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2,TRIM(UNSEEDED.CURRENT_LINE1)))
  /length(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2) as score,
  AD_BASE.ADDRESS_STRING_NOPC
  FROM UNSEEDED,AD_BASE
 WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
and regexp_replace(TRIM(regexp_replace(UNSEEDED.CURRENT_LINE1,'[A-Z]','')),'[[:space:]]{2,}', '')=AD_BASE.SUB_UNIT
AND AD_BASE.BUILD_NO IS NULL
--NEEDS WORK ON SCORING AND TO ENSURE LINE 2 IS SIMILAR
 AND (INSTR(UNSEEDED.CURRENT_LINE1,ad_base.ABBR_STREET1,1,1)>0 OR INSTR(UNSEEDED.CURRENT_LINE1,AD_BASE.DESCRIPTION ,1,1)>0);
 ------------------
 UPDATE RESULTS35 SET STAGE= '35';
 -------------------
 CREATE TABLE RESULTS35A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE, MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,MAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS35)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS35A
COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS35A Where UNSEEDED.ID = RESULTS35A.ID);
COMMIT;
drop table "RESULTS35";

create table results36 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
UNSEEDED.CURRENT_LINE1,
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_LINE_1,
  (length(TRIM(UNSEEDED.CURRENT_LINE1)) 
  - SYS.UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2,TRIM(UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2) as score,
  AD_BASE.ADDRESS_STRING_NOPC
  FROM UNSEEDED,AD_BASE
 WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
and regexp_replace(TRIM(regexp_replace(UNSEEDED.CURRENT_LINE2,'[A-Z]','')),'[[:space:]]{2,}', '')=AD_BASE.SUB_UNIT
AND AD_BASE.BUILD_NO IS NULL
--NEEDS WORK ON SCORING AND TO ENSURE LINE 2 IS SIMILAR
 AND (INSTR(UNSEEDED.CURRENT_LINE2,ad_base.ABBR_STREET1,1,1)>0 OR INSTR(UNSEEDED.CURRENT_LINE2,AD_BASE.DESCRIPTION ,1,1)>0) ;

UPDATE RESULTS36 SET STAGE= '36';

 CREATE TABLE RESULTS36A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE, MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,MAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS36)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS36A
COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS36A Where UNSEEDED.ID = RESULTS36A.ID);
COMMIT;
drop table "RESULTS36";

create table results37 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
UNSEEDED.CURRENT_LINE1,
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_LINE_1,
  (length(TRIM(UNSEEDED.CURRENT_LINE1)) 
  - SYS.UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2,TRIM(UNSEEDED.CURRENT_LINE1)))
  /length(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2) as score,
  AD_BASE.ADDRESS_STRING_NOPC
  FROM UNSEEDED,AD_BASE
 WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
and regexp_replace(TRIM(regexp_replace(UNSEEDED.CURRENT_LINE1,'[A-Z]','')),'[[:space:]]{2,}', '')=AD_BASE.SUB_UNIT
AND AD_BASE.BUILD_NO IS NULL
and length(UNSEEDED.CURRENT_LINE1)>4
and length(AD_BASE.ADDRESS_LINE_1)>4
--NEEDS WORK ON SCORING AND TO ENSURE LINE 2 IS SIMILAR
 AND (INSTR(UNSEEDED.CURRENT_LINE1,AD_BASE.sub_unit||' '||ad_base.ABBR_STREET1,1,1)>0 OR INSTR(UNSEEDED.CURRENT_LINE1,AD_BASE.sub_unit|| ' ' ||AD_BASE.DESCRIPTION ,1,1)>0) 
 and  (length(TRIM(UNSEEDED.CURRENT_LINE1)) 
  - SYS.UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2,TRIM(UNSEEDED.CURRENT_LINE1)))
  /length(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2)>0.3;

UPDATE RESULTS37 SET STAGE= '37';

CREATE TABLE RESULTS37A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE, MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,MAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS37)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS37A
COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS37A Where UNSEEDED.ID = RESULTS37A.ID);
COMMIT;
drop table "RESULTS37";

--create table results388 as SELECT 
--UNSEEDED.ID,
--UNSEEDED.STAGE,
--UNSEEDED.ADDRESS_STRING, 
--UNSEEDED.CURRENT_LINE1,
--AD_BASE.UPRN,
--AD_BASE.PARENT_UPRN,
  --AD_BASE.ADDRESS_LINE_1,
 -- (length(TRIM(UNSEEDED.CURRENT_LINE1)) 
  -- - SYS.UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2,TRIM(UNSEEDED.CURRENT_LINE1||' '||UNSEEDED.CURRENT_LINE2)))
  --/length(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2) as score,
  --AD_BASE.ADDRESS_STRING_NOPC
  --FROM UNSEEDED,AD_BASE
 --WHERE AD_BASE.H3_8=UNSEEDED.H3_8_P
----AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.ADD_STRING_WORKING,1,1)>0
 --AND INSTR(AD_BASE.ADD_NUM,UNSEEDED.BUILD_NO,1,1)>0;
----NEEDS WORK ON SCORING AND TO ENSURE LINE 2 IS SIMILAR
 ----AND TO_NUMBER(UNSEEDED.BUILD_NUM) BETWEEN TO_NUMBER(AD_BASE.LOWER) AND TO_NUMBER(AD_BASE.UPPER)
 ----and ad_base.word_three=UNSEEDED.word_three
 --and   (length(TRIM(UNSEEDED.CURRENT_LINE1)) 
  -- - SYS.UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2,TRIM(UNSEEDED.CURRENT_LINE1||' '||UNSEEDED.CURRENT_LINE2)))
  --/length(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2)>0.3;

--UPDATE RESULTS38 SET STAGE= '38';

--CREATE TABLE RESULTS38A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE, MAX_SCORE,COUNT_P_UPRN FROM(
--SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,MAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
--DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
--FROM RESULTS38)
--WHERE SCORE = MAX_SCORE 
--AND COUNT_P_UPRN =1
--ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

--ALTER TABLE RESULTS38A
--COMPRESS;
---------------------------------------
--DELETE FROM UNSEEDED
--WHERE EXISTS( SELECT id FROM RESULTS38A Where UNSEEDED.ID = RESULTS38A.ID);
--COMMIT;
--drop table "RESULTS38";
-------------------------------
------------------------------
create table results39 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING, 
UNSEEDED.CURRENT_LINE1,
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_LINE_1,
  (length(TRIM(UNSEEDED.ADD_NUM||' '||UNSEEDED.CURRENT_LINE2)) 
  - SYS.UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2,TRIM(UNSEEDED.ADD_NUM||' '||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1|| ' '||AD_BASE.ADDRESS_LINE_2) as score,
  AD_BASE.ADDRESS_STRING_NOPC
  FROM UNSEEDED,AD_BASE
 WHERE AD_BASE.H3_7=UNSEEDED.H3_7_P
AND regexp_replace(UNSEEDED.ADD_NUM,'[[:space:]]{2,}', '')=regexp_replace(AD_BASE.ADDRESS_LINE_1,'[[:space:]]{2,}', '')
AND regexp_replace(UNSEEDED.CURRENT_LINE2,'[[:space:]]{2,}', '')=regexp_replace(AD_BASE.ADDRESS_LINE_2,'[[:space:]]{2,}', '');
-----------------------
UPDATE RESULTS39 SET STAGE= '39';
-----------------------
CREATE TABLE RESULTS39A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE, MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,MAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS39)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS39A
COMPRESS;
---------------------------------------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS39A Where UNSEEDED.ID = RESULTS39A.ID);
COMMIT;
drop table "RESULTS39";

CREATE TABLE RESULTs40 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.current_line1)) - 
  UTL_MATCH.jaro_winkler(ad_base.ADDRESS_line_1,TRIM(LEADING FROM UNSEEDED.current_line1)))
  /length(ad_base.ADDRESS_line_1) as score1,
  (length(TRIM(LEADING FROM UNSEEDED.current_line1)) - 
  UTL_MATCH.jaro_winkler(ad_base.ADDRESS_line_2,TRIM(LEADING FROM UNSEEDED.current_line2)))
  /length(ad_base.ADDRESS_line_2) as score2
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
and ad_base.add_num is null and UNSEEDED.add_num is null
--AND INSTR(AD_BASE.ADD_NUM,UNSEEDED.ADD_NUM,1,1)>0
AND INSTR(ad_base.ADDRESS_STRING_NOPC,UNSEEDED.WORD_ONE||' '||UNSEEDED.WORD_TWO,1,1)>0
--OR INSTR(ad_base.ADDRESS_STRING_NOPC,UNSEEDED.WORD_TWO||' '||UNSEEDED.WORD_THREE,1,1)>0 
--OR INSTR(ad_base.ADDRESS_STRING_NOPC,UNSEEDED.WORD_THREE||' '||UNSEEDED.WORD_FOUR,1,1)>0
--OR INSTR(ad_base.ADDRESS_STRING_NOPC,UNSEEDED.WORD_FOUR||' '||UNSEEDED.WORD_FIVE,1,1)>0)
AND (INSTR(UNSEEDED.ADDRESS_STRING,ad_base.DESCRIPTION,1,1)>0 or instr(UNSEEDED.ADDRESS_STRING,ad_base.ABBR_STREET1,1,1)>0);

UPDATE RESULTS40 SET STAGE= '40';

CREATE TABLE RESULTS40A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS40)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS40A
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS40A Where UNSEEDED.ID = RESULTS40A.ID);
COMMIT;
drop table "RESULTS40";
------------- problem at stage 41 to include number logic
CREATE TABLE RESULTs41 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.current_line1)) - 
  UTL_MATCH.jaro_winkler(ad_base.ADDRESS_line_1,TRIM(LEADING FROM UNSEEDED.current_line1)))
  /length(ad_base.ADDRESS_line_1) as score1,
  (length(TRIM(LEADING FROM UNSEEDED.current_line1)) - 
  UTL_MATCH.jaro_winkler(ad_base.ADDRESS_line_2,TRIM(LEADING FROM UNSEEDED.current_line2)))
  /length(ad_base.ADDRESS_line_2) as score2
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
and UNSEEDED.build_no=ad_base.build_no 

--AND INSTR(AD_BASE.ADD_NUM,UNSEEDED.ADD_NUM,1,1)>0
AND INSTR(ad_base.ADDRESS_STRING_NOPC,UNSEEDED.WORD_ONE||' '||UNSEEDED.WORD_TWO,1,1)>0
--OR INSTR(ad_base.ADDRESS_STRING_NOPC,UNSEEDED.WORD_TWO||' '||UNSEEDED.WORD_THREE,1,1)>0 
--OR INSTR(ad_base.ADDRESS_STRING_NOPC,UNSEEDED.WORD_THREE||' '||UNSEEDED.WORD_FOUR,1,1)>0
--OR INSTR(ad_base.ADDRESS_STRING_NOPC,UNSEEDED.WORD_FOUR||' '||UNSEEDED.WORD_FIVE,1,1)>0)
AND (INSTR(UNSEEDED.ADDRESS_STRING,ad_base.DESCRIPTION,1,1)>0 or instr(UNSEEDED.ADDRESS_STRING,ad_base.ABBR_STREET1,1,1)>0);
UPDATE RESULTS41 SET STAGE= '41';

CREATE TABLE RESULTS41A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS41)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS41A
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS41A Where UNSEEDED.ID = RESULTS41A.ID);
COMMIT;
drop table "RESULTS41";
-------------------
CREATE TABLE RESULTS42 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
  UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_7=UNSEEDED.H3_7_p 
and length(UNSEEDED.CURRENT_LINE1)>3
AND (UNSEEDED.add_num=AD_BASE.add_num or UNSEEDED.add_num is null and AD_BASE.add_num is null)
AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.CURRENT_LINE1,1,1)>0 ;

CREATE TABLE RESULTS42_2 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_7=UNSEEDED.H3_7_p 
and length(UNSEEDED.CURRENT_LINE1)>3
AND (UNSEEDED.add_num=AD_BASE.ADD_NUM or (UNSEEDED.add_num is null and AD_BASE.add_num is null))
AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.CURRENT_LINE1,1,1)>0 ;

CREATE TABLE RESULTS42_3 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_6=UNSEEDED.H3_6_p 
and length(UNSEEDED.CURRENT_LINE1)>3
AND UNSEEDED.BUILD_NO IS NULL AND UNSEEDED.SUB_UNIT=AD_BASE.ADD_NUM
AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.CURRENT_LINE1,1,1)>0 ;
-------------

CREATE TABLE ALL_42 AS 
select * from RESULTS42
union 
select * from RESULTS42_2
union
select * from RESULTS42_3;

UPDATE ALL_42 SET STAGE= '42';

CREATE TABLE RESULTS42A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID,STAGE, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM ALL_42)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS42A COMPRESS;

----------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS42A Where UNSEEDED.ID = RESULTS42A.ID);
COMMIT;
drop table "RESULTS42";
drop table "RESULTS42_2";
drop table "RESULTS42_3";
drop table "ALL_42";
------------------------
CREATE TABLE RESULTS43 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_8=UNSEEDED.H3_8_p 
and length(UNSEEDED.CURRENT_LINE1)>3
AND replace(AD_BASE.ADDRESS_LINE_1,' ','') =REPLACE(CURRENT_LINE1,' ','') 
AND (UNSEEDED.ADD_NUM IS NULL OR (UNSEEDED.ADD_NUM = AD_BASE.SUB_UNIT AND AD_BASE.BUILD_NO IS NULL));
-------------
UPDATE RESULTS43 SET STAGE= '43';

CREATE TABLE RESULTS43A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS43)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS43A
COMPRESS;

----------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS43A Where UNSEEDED.ID = RESULTS43A.ID);
COMMIT;
drop table "RESULTS43";
--------------
CREATE TABLE RESULTS44 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_7=UNSEEDED.H3_7_p 
and length(UNSEEDED.CURRENT_LINE1)>3
AND replace(AD_BASE.ADDRESS_LINE_1,' ','') =REPLACE(CURRENT_LINE2,' ','') 
AND (UNSEEDED.ADD_NUM IS NULL OR (UNSEEDED.ADD_NUM = AD_BASE.SUB_UNIT AND AD_BASE.BUILD_NO IS NULL) OR UNSEEDED.ADD_NUM = AD_BASE.ADD_NUM );
UPDATE RESULTS44 SET STAGE= '44';

CREATE TABLE RESULTS44A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS44)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS44A
COMPRESS;

----------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS44A Where UNSEEDED.ID = RESULTS44A.ID);
COMMIT;
drop table "RESULTS44";

CREATE TABLE RESULTS45 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_6=UNSEEDED.H3_6_p 
--and length(UNSEEDED.CURRENT_LINE1)>3
AND replace(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_3,' ','') =REPLACE(CURRENT_LINE1||CURRENT_LINE2,' ','') 
AND (UNSEEDED.ADD_NUM IS NULL OR (UNSEEDED.ADD_NUM = AD_BASE.SUB_UNIT AND AD_BASE.BUILD_NO IS NULL) OR UNSEEDED.ADD_NUM = AD_BASE.ADD_NUM );
UPDATE RESULTS45 SET STAGE= '45';
--------------
CREATE TABLE RESULTS45A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS45)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS45A
COMPRESS;

----------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS45A Where UNSEEDED.ID = RESULTS45A.ID);
COMMIT;
drop table "RESULTS45";



UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,'C/VAN|CVN|',' CARAVAN ');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,'C/SITE',' CARAVAN SITE');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,'CARAVAN PK|C/PARK',' CARAVAN SITE');

UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' FA$|FHOUSE$| FM$|F/HOUS$| FA$|FAHOUSE$', ' FARMHOUSE');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' COTTS$| COTT$| COT$ ', ' COTTAGE');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' HTL$|HOT$', ' HOTEL');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' HSE$', ' HOUSE');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' COLL$| COL$', ' COLLEGE');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' LDG$', ' LODGE');

UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' EST$', ' ESTATE');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' PK ', ' PARK');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' SCH$', ' SCHOOL');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' BLDGS$', ' BUILDINGS');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' GDN ', ' GARDEN');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' RES$', ' RESIDENCE');

UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' BUNG$', ' BUNGALOW');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' CTRE$', ' CENTRE');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' COMM$', ' COMMUNITY');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' N/HME$', ' NURSING HOME');
UPDATE UNSEEDED SET CURRENT_LINE1= regexp_replace(UNSEEDED.CURRENT_LINE1,' HO | HME ', ' HOME');

CREATE TABLE RESULTS46 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_8=UNSEEDED.H3_8_p 
and length(UNSEEDED.CURRENT_LINE1)>3
AND replace(AD_BASE.ADDRESS_LINE_1,' ','') =REPLACE(CURRENT_LINE1,' ','') 
AND (UNSEEDED.ADD_NUM IS NULL OR (UNSEEDED.ADD_NUM = AD_BASE.SUB_UNIT AND AD_BASE.BUILD_NO IS NULL));

UPDATE RESULTS46 SET STAGE= '46';
CREATE TABLE RESULTS46A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS46)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS46A
COMPRESS;

----------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS46A Where UNSEEDED.ID = RESULTS46A.ID);
COMMIT;
drop table "RESULTS46";

CREATE TABLE RESULTS47 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_8=UNSEEDED.H3_8_p 
and length(UNSEEDED.CURRENT_LINE1)>3
AND replace(AD_BASE.ADDRESS_LINE_2,' ','') =REPLACE(CURRENT_LINE1,' ','') 
AND (UNSEEDED.ADD_NUM IS NULL OR (UNSEEDED.ADD_NUM = AD_BASE.SUB_UNIT AND AD_BASE.BUILD_NO IS NULL));

UPDATE RESULTS47 SET STAGE= '47';

CREATE TABLE RESULTS47A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS47)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS47A
COMPRESS;

----------
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS47A Where UNSEEDED.ID = RESULTS47A.ID);
COMMIT;
drop table "RESULTS47";

--------
CREATE TABLE RESULTS48 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
UNSEEDED.ADDRESS_STRING,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'[[:space:]]|,|[.]', '')) - SYS.UTL_MATCH.JARO_WINKLER(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'[[:space:]]|,|[.]', ''),
regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|[.]', '')))  /length(regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|[.]', '')) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_8=UNSEEDED.H3_8_p 
 AND ((LENGTH(UNSEEDED.WORD_ONE)>3 AND LENGTH(UNSEEDED.WORD_ONE)<30 AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.WORD_ONE,1,1)>0 )
 OR(INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.WORD_ONE,1,1)>0 AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.WORD_TWO,1,1)>0))
and( UNSEEDED.add_num=ad_base.add_num or (UNSEEDED.add_num is null and ad_base.add_num is null));

UPDATE RESULTS48 SET STAGE= '48';

CREATE TABLE RESULTS48A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS48)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS48A
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS48A Where UNSEEDED.ID = RESULTS48A.ID);
COMMIT;
drop table "RESULTS48";
-- add some non number queries




CREATE TABLE RESULTS49 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|[.]', '')) - SYS.UTL_MATCH.JARO_WINKLER(regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|[.]', ''),
regexp_replace(AD_BASE.address_string_nopc,'[[:space:]]|,|[.]', '')))  /length(regexp_replace(Ad_base.address_string_nopc,'[[:space:]]|,|[.]', '')) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_8=UNSEEDED.H3_8_p 
 AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.WORD_one,1,1)>0 
 AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.WORD_TWO,1,1)>0
AND AD_BASE.add_num IS NULL AND UNSEEDED.add_num IS NULL
AND (INSTR(UNSEEDED.ADDRESS_STRING,ad_base.ABBR_STREET1,1,1)>0 
OR INSTR(UNSEEDED.ADDRESS_STRING,AD_BASE.DESCRIPTION,1,1)>0);--CONSIDER REVERSING INSTR SEARCH AS A WAY TO AVOID HIGH CRESENT NORTH MATCHING HIGH CRESCENT19-08-22

UPDATE RESULTS49 SET STAGE= '49';

CREATE TABLE RESULTS49a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS49)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1 and score1>0.85
ORDER BY ID,ADDRESS_STRING, ADDRESS_STRING_NOPC;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS49A Where UNSEEDED.ID = RESULTS49A.ID);
COMMIT;
drop table "RESULTS49";

ALTER TABLE RESULTS49A
COMPRESS;

CREATE TABLE RESULTS50 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(UNSEEDED.ADDRESS_STRING) - 
SYS.UTL_MATCH.JARO_WINKLER(UNSEEDED.ADDRESS_STRING,AD_BASE.address_string_nopc))  /length(Ad_base.address_string_nopc) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_8=UNSEEDED.H3_8_p 
--AND (length(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'[[:space:]]|,|.', '')) - SYS.UTL_MATCH.JARO_WINKLER(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'[[:space:]]|,|.', ''),
--regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|.', '')))  /length(regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|.', ''))>0.6
 AND ((LENGTH(UNSEEDED.WORD_ONE)>3 AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.WORD_ONE,1,1)>0 )OR(INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.WORD_two,1,1)>0 
 AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.WORD_TWO,1,1)>0)OR(INSTR(UNSEEDED.ADDRESS_STRING,AD_BASE.WORD_ONE,1,1)>0 ))
and (UNSEEDED.add_num=AD_BASE.sub_unit and AD_BASE.build_no is null)
--((INSTR(UNSEEDED.SUB_UNIT,AD_BASE.SUB_UNIT,1,1)>0 AND AD_BASE.BUILD_NO IS NULL AND UNSEEDED.BUILD_NO IS NULL) 
--OR (INSTR(AD_BASE.add_num,UNSEEDED.SUB_UNIT,1,1)>0 AND UNSEEDED.BUILD_NO IS NULL AND UNSEEDED.BUILD_NO IS NULL)
--AND(CONVERT(UNSEEDED.SUB_UNIT,INTEGER)- CONVERT(AD_BASE.SUB_UNIT,INTEGER)=0 AND AD_BASE.BUILD_NO IS NULL AND UNSEEDED.BUILD_NO IS NULL

--AND (AD_BASE.add_num IS NULL AND UNSEEDED.add_num IS NULL)  
--AND INSTR(UNSEEDED.add_num,AD_BASE.add_num,1,1)>0
AND (INSTR(UNSEEDED.ADDRESS_STRING,ad_base.ABBR_STREET1,1,1)>0 OR INSTR(UNSEEDED.ADDRESS_STRING,AD_BASE.DESCRIPTION,1,1)>0);
--AND (INSTR(replace(UNSEEDED.ADDRESS_STRING,' ',''),replace(ad_base.DESCRIPTION,' ',''),1,1)>0 or instr(replace(UNSEEDED.ADDRESS_STRING,' ',''),replace(ad_base.ABBR_STREET1,' ',''),1,1)>0);

UPDATE RESULTS50 SET STAGE= '50';

CREATE TABLE RESULTS50a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS50)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1 and score1>0.85
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS50A Where UNSEEDED.ID = RESULTS50A.ID);
COMMIT;


drop table "RESULTS50";
ALTER TABLE RESULTS50A
COMPRESS;

CREATE TABLE RESULTS51 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|[.]', '')) - SYS.UTL_MATCH.JARO_WINKLER(regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|[.]', ''),
regexp_replace(AD_BASE.address_string_nopc,'[[:space:]]|,|[.]', '')))  /length(regexp_replace(Ad_base.address_string_nopc,'[[:space:]]|,|[.]', '')) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_8=UNSEEDED.H3_8_p 
 AND ((LENGTH(UNSEEDED.WORD_ONE)>3 AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.WORD_ONE,1,1)>0 )OR(INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.WORD_two,1,1)>0 
 AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.WORD_TWO,1,1)>0)OR(INSTR(UNSEEDED.ADDRESS_STRING,AD_BASE.WORD_ONE,1,1)>0 ))
and (regexp_replace(UNSEEDED.add_num,'[[:space:]]|,|[.]', '')=regexp_replace(ad_base.add_num,'[[:space:]]|,|[.]', '')
or (regexp_replace(UNSEEDED.SUB_UNIT,'[[:space:]]|,|[.]', '')=regexp_replace(AD_BASE.SUB_UNIT,'[[:space:]]|,|[.]', '') AND AD_BASE.BUILD_NO IS NULL AND UNSEEDED.BUILD_NO IS NULL)) 
AND (INSTR(UNSEEDED.ADDRESS_STRING,ad_base.ABBR_STREET1,1,1)>0 OR INSTR(UNSEEDED.ADDRESS_STRING,AD_BASE.DESCRIPTION,1,1)>0);

UPDATE RESULTS51 SET STAGE= '51';

CREATE TABLE RESULTS51a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS51)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS51A Where UNSEEDED.ID = RESULTS51A.ID);
COMMIT;
drop table "RESULTS51";

ALTER TABLE RESULTS51A COMPRESS;

CREATE TABLE RESULTS52 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'[[:space:]]|,|[.]', '')) - SYS.UTL_MATCH.JARO_WINKLER(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'[[:space:]]|,|[.]', ''),
regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|[.]', '')))  /length(regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|[.]', '')) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_6=UNSEEDED.H3_6_p 
 AND ((LENGTH(UNSEEDED.WORD_ONE)>3 AND INSTR(UNSEEDED.ADDRESS_STRING,ad_base.WORD_ONE,1,1)>0 )and(INSTR(UNSEEDED.ADDRESS_STRING,ad_base.WORD_two,1,1)>0 ))
and( UNSEEDED.add_num=ad_base.add_num or (UNSEEDED.add_num is null and ad_base.add_num is null) or regexp_replace(AD_BASE.ADD_num,'[[:space:]]|,|[.]', '')=regexp_replace(UNSEEDED.ADD_num,'[[:space:]]|,|[.]', ''))
AND (INSTR(replace(UNSEEDED.ADDRESS_STRING,' ',''),replace(ad_base.DESCRIPTION,' ',''),1,1)>0 or INSTR(replace(UNSEEDED.ADDRESS_STRING,' ',''),replace(ad_base.ABBR_STREET1,' ',''),1,1)>0);

UPDATE RESULTS52 SET STAGE= '52';

CREATE TABLE RESULTS52a AS SELECT DISTINCT ID,stage,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID,stage, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS52)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1 
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS52A Where UNSEEDED.ID = RESULTS52A.ID);
COMMIT;

drop table "RESULTS52";

ALTER TABLE RESULTS52A COMPRESS;


CREATE TABLE RESULTS53 AS SELECT 
UNSEEDED.ID,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.STAGE,
UNSEEDED.ADD_NUM as in_num,
UNSEEDED.RANGE_LOWER,
UNSEEDED.RANGE_UPPER,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
UNSEEDED.current_line2,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.Current_line1)) - 
  UTL_MATCH.jaro_winkler(AD_BASE.ADDRESS_line_1,TRIM(LEADING FROM UNSEEDED.Current_line1)))
  /length(AD_BASE.ADDRESS_line_1) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_6=UNSEEDED.H3_6_p 
and((UNSEEDED.sub_unit is not null and UNSEEDED.build_no is null) and (AD_BASE.ADD_NUM = UNSEEDED.SUB_UNIT))
AND (INSTR(UNSEEDED.ADDRESS_STRING,AD_BASE.description,1,1)>0 
or instr(UNSEEDED.ADDRESS_STRING,ad_base.ABBR_STREET1,1,1)>0)
and instr(UNSEEDED.ADDRESS_STRING,AD_BASE.post_town ,1,1)>0;

UPDATE RESULTS53 SET STAGE= '53';

CREATE TABLE RESULTS53a AS SELECT DISTINCT ID,stage,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID,stage, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS53)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1 and score1>0.7
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS53A Where UNSEEDED.ID = RESULTS53A.ID);
COMMIT;
drop table "RESULTS53";

ALTER TABLE RESULTS52A COMPRESS;

CREATE TABLE RESULTS54 AS SELECT 
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.CURRENT_LINE1,
AD_BASE.ADDRESS_LINE_1,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
(length(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'[[:space:]]|,|[.]', '')) - SYS.UTL_MATCH.JARO_WINKLER(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'[[:space:]]|,|[.]', ''),
regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|[.]', '')))  /length(regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|[.]', '')) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_7=UNSEEDED.H3_7_p 
--AND (length(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'[[:space:]]|,|.', '')) - SYS.UTL_MATCH.JARO_WINKLER(regexp_replace(AD_BASE.ADDRESS_STRING_NOPC,'[[:space:]]|,|.', ''),
--regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|.', '')))  /length(regexp_replace(UNSEEDED.ADDRESS_STRING,'[[:space:]]|,|.', ''))>0.6
 AND ((LENGTH(UNSEEDED.WORD_ONE)>3 AND INSTR(UNSEEDED.ADDRESS_STRING,ad_base.WORD_ONE,1,1)>0 )and(INSTR(UNSEEDED.ADDRESS_STRING,ad_base.WORD_two,1,1)>0 ))
and( UNSEEDED.add_num=ad_base.add_num or (UNSEEDED.add_num is null and ad_base.add_num is null) or regexp_replace(AD_BASE.ADD_num,'[[:space:]]|,|[.]', '')=regexp_replace(UNSEEDED.ADD_num,'[[:space:]]|,|[.]', ''
)
or ((UNSEEDED.sub_unit is not null and UNSEEDED.build_no is null) and (AD_BASE.ADD_NUM = UNSEEDED.SUB_UNIT)))
AND (INSTR(replace(UNSEEDED.ADDRESS_STRING,' ',''),replace(ad_base.DESCRIPTION,' ',''),1,1)>0 or INSTR(replace(UNSEEDED.ADDRESS_STRING,' ',''),replace(ad_base.ABBR_STREET1,' ',''),1,1)>0);
------
UPDATE RESULTS54 SET STAGE= '54';

CREATE TABLE RESULTS54a AS SELECT DISTINCT ID,stage,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID,stage, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS54)
WHERE SCORE1 = MAX_SCORE 
AND COUNT_P_UPRN =1 and score1>0.65
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS54A Where UNSEEDED.ID = RESULTS54A.ID);
COMMIT;
drop table "RESULTS54";

ALTER TABLE RESULTS54A COMPRESS;
------
CREATE TABLE RESULTS55 AS SELECT 
UNSEEDED.ID,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.STAGE,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
AD_BASE.WORD_ONE,
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC ,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
  UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1,
  UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_8=UNSEEDED.H3_8_p 
--AND INSTR(AD_BASE.ADD_NUM,UNSEEDED.ADD_NUM,1,1)>0
AND (REGEXP_INSTR(UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2,'HOUSE',1,1)>0 
AND REGEXP_INSTR(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,'HOUSE',1,1)>0 )
AND AD_BASE.CLASSIFICATION_TERTIARY= 'Care / Nursing Home' ;

CREATE TABLE RESULTS55B AS SELECT 
UNSEEDED.ID,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.STAGE,
AD_BASE.WORD_ONE,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC ,
   UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
  UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_10=UNSEEDED.H3_10_p 
AND REGEXP_INSTR(UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2,'HOME',1,1)>0 
AND REGEXP_INSTR(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,'HOME',1,1)>0 
AND AD_BASE.CLASSIFICATION_TERTIARY= 'Care / Nursing Home' ;

CREATE TABLE RESULTS55C AS SELECT 
UNSEEDED.ID,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.STAGE,
AD_BASE.WORD_ONE,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC ,
   UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
  UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_10=UNSEEDED.H3_10_p 
AND REGEXP_INSTR(UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2,'N /HO| C HME| NRS HME|R H|REST HOME|R/HOME|OPH| CARE UNIT| CARE CENTRE 
|C/ CENTRE | CARE HOME| C H| CH|CARE H|C/HOME|C/HOME|C HOME|CARE',1,1)>0 
AND REGEXP_INSTR(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,'RESIDENTIAL|CARE HOME|NURSING HOME',1,1)>0 
AND AD_BASE.CLASSIFICATION_TERTIARY= 'Care / Nursing Home' ;

CREATE TABLE RESULTS55D AS SELECT 
UNSEEDED.ID,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.STAGE,
AD_BASE.WORD_ONE,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC ,
   UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
  UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_10=UNSEEDED.H3_10_p 
AND REGEXP_INSTR(UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2,'CENTRE|CARE| RESIDENTIAL|UNIT|RESIDENTIAL|CARE HOME|NURSING HOME',1,1)>0 
AND REGEXP_INSTR(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,'CENTRE|CARE| RESIDENTIAL|UNIT|RESIDENTIAL|CARE HOME|NURSING HOME',1,1)>0 
AND AD_BASE.CLASSIFICATION_TERTIARY= 'Care / Nursing Home' ;

CREATE TABLE RESULTS55E AS SELECT 
UNSEEDED.ID,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.STAGE,
AD_BASE.WORD_ONE,
UNSEEDED.ADD_NUM as in_num,
ad_base.description,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC ,
   UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)) - 
  UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2)))
  /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2) as score1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.h3_10=UNSEEDED.H3_10_p 
AND REGEXP_INSTR(UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2,'N/ HOME|N /HO|C HME| NRS HME| R H|REST HOME|RESIDENTIAL |RES HOME|R/HOME|R H|RESIDENTIAL|CARE HOME|NURSING HOME|OPH |NURSING|NURSING H|NURSING/H|NURS H | N/H|N H|NURSING HOME|NURSING HO|
NURSING HO | N HOME|N/HOME',1,1)>0 
AND REGEXP_INSTR(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2,'N/ HOME|N /HO|C HME| NRS HME| R H|REST HOME|RESIDENTIAL |RES HOME|R/HOME|R H|RESIDENTIAL|CARE HOME|NURSING HOME|OPH |NURSING|NURSING H|NURSING/H|NURS H | N/H|N H|NURSING HOME|NURSING HO|
NURSING HO | N HOME|N/HOME',1,1)>0 
AND AD_BASE.CLASSIFICATION_TERTIARY= 'Care / Nursing Home' ;

CREATE TABLE CH_union AS 
select * from RESULTS55
union 
select * from RESULTS55B
union
select * from RESULTS55C
union 
select * from RESULTS55D
union 
select * from RESULTS55E;

drop table "RESULTS55" ;
drop table "RESULTS55B" ;
drop table "RESULTS55C" ;
drop table "RESULTS55D" ;
drop table "RESULTS55E" ;

alter table "CH_UNION" compress;

UPDATE CH_UNION SET STAGE= '55';

CREATE TABLE RESULTS55a AS SELECT DISTINCT ID,stage,UPRN,WORD_ONE,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID,stage, UPRN,PARENT_UPRN, ADDRESS_STRING,WORD_ONE, ADDRESS_STRING_NOPC, SCORE1,mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM CH_UNION)
WHERE SCORE1 >0.5 
AND COUNT_P_UPRN =1
AND INSTR( ADDRESS_STRING_NOPC,WORD_ONE,1,1)>0
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS55A Where UNSEEDED.ID = RESULTS55A.ID);
COMMIT;

drop table ch_union;

create table results57 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  (length(TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2||UNSEEDED.CURRENT_LINE3)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2||AD_BASE.ADDRESS_LINE_3,
  TRIM(LEADING FROM UNSEEDED.CURRENT_LINE1||UNSEEDED.CURRENT_LINE2||UNSEEDED.CURRENT_LINE3)))
  /length(AD_BASE.ADDRESS_LINE_1) as score,
  AD_BASE.ADDRESS_STRING_NOPC
FROM UNSEEDED,AD_BASE
 WHERE UNSEEDED.CURRENT_LINE1=AD_BASE.ADDRESS_string_nopc; 
 
 UPDATE RESULTS57 SET STAGE= '57';

CREATE TABLE RESULTS57a AS SELECT DISTINCT ID,stage,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID,stage, UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTs57)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1 
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS57A Where UNSEEDED.ID = RESULTS57A.ID);
COMMIT;
drop table "RESULTS57";

ALTER TABLE RESULTS57A COMPRESS;
 
 create table results_neigh1 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  AD_BASE.LOCALITY,
  ad_base.post_town,
  (length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) 
 - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2||AD_BASE.ADDRESS_LINE_3||AD_BASE.POST_TOWN,TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))
 /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2||AD_BASE.ADDRESS_LINE_3||AD_BASE.POST_TOWN) as score1
FROM UNSEEDED,AD_BASE
 WHERE 
  INSTR(UNSEEDED.NEIGHBOURS,ad_base.h3_4,1,1)>0
 and ad_base.Add_num=UNSEEDED.add_num
AND( INSTR(UNSEEDED.address_string ,AD_BASE.post_town,1,1)>0 OR INSTR(UNSEEDED.address_string ,AD_BASE.LOCALITY,1,1)>0)
AND (instr(UNSEEDED.ADDRESS_STRING,AD_BASE.DESCRIPTION,1,1)>0 OR instr(UNSEEDED.ADDRESS_STRING,ad_base.ABBR_STREET1,1,1)>0);

create table results_neigh2 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  AD_BASE.LOCALITY,
  ad_base.post_town,
  (length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) 
 - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2||AD_BASE.ADDRESS_LINE_3||AD_BASE.POST_TOWN,TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))
 /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2||AD_BASE.ADDRESS_LINE_3||AD_BASE.POST_TOWN) as score1
FROM UNSEEDED,AD_BASE
 WHERE 
  INSTR(UNSEEDED.NEAR_NEIGHBOURS,ad_base.h3_4,1,1)>0
 and ad_base.Add_num=UNSEEDED.add_num
AND( INSTR(UNSEEDED.address_string ,AD_BASE.post_town,1,1)>0 OR INSTR(UNSEEDED.address_string ,AD_BASE.LOCALITY,1,1)>0)
AND (instr(UNSEEDED.ADDRESS_STRING,AD_BASE.DESCRIPTION,1,1)>0 OR instr(UNSEEDED.ADDRESS_STRING,ad_base.ABBR_STREET1,1,1)>0);
 
 create table results_neigh3 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  AD_BASE.LOCALITY,
  ad_base.post_town,
  (length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) 
 - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2||AD_BASE.ADDRESS_LINE_3||AD_BASE.POST_TOWN,TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))
 /length(AD_BASE.ADDRESS_LINE_1||AD_BASE.ADDRESS_LINE_2||AD_BASE.ADDRESS_LINE_3||AD_BASE.POST_TOWN) as score1
FROM UNSEEDED,AD_BASE
 WHERE 
  INSTR(UNSEEDED.NEAR_NEIGHBOURS,ad_base.h3_4,1,1)>0
 and ad_base.build_no=UNSEEDED.build_no
AND( INSTR(UNSEEDED.address_string ,AD_BASE.post_town,1,1)>0 OR INSTR(UNSEEDED.address_string ,AD_BASE.LOCALITY,1,1)>0)
AND (instr(UNSEEDED.ADDRESS_STRING,AD_BASE.DESCRIPTION,1,1)>0 OR instr(UNSEEDED.ADDRESS_STRING,ad_base.ABBR_STREET1,1,1)>0);
 
 CREATE TABLE TEST AS 
select * from RESULTS_NEIGH1
union 
select * from RESULTS_NEIGH2
union 
select * from RESULTS_NEIGH3;
UPDATE TEST SET STAGE= '3.1';  

drop table "RESULTS_NEIGH1" ;

drop table "RESULTS_NEIGH3" ;

CREATE TABLE RESULTS3AA AS SELECT DISTINCT STAGE, ID, UPRN, PARENT_UPRN,ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1, MAX_SCORE FROM(
SELECT STAGE,ID, UPRN, PARENT_UPRN,ADDRESS_STRING,  ADDRESS_STRING_NOPC, SCORE1,
       MAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE
   FROM TEST)
   WHERE SCORE1 = MAX_SCORE and score1>0.75
 ORDER BY ID, ADDRESS_STRING_NOPC;
 
 ALTER TABLE RESULTS3AA COMPRESS;
 
DELETE FROM UNSEEDED
WHERE EXISTS( SELECT 1 FROM RESULTS3AA Where UNSEEDED.ID = RESULTS3AA.ID);
COMMIT;
drop table "TEST" ; 
 ----
 ----
 CREATE TABLE RESULTS58 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  REGEXP_SUBSTR(UNSEEDED.current_line1,'[[:alpha:]].*') TEST_STREET,
  UTL_MATCH.jaro_winkler(REGEXP_SUBSTR(UNSEEDED.current_line1,'[[:alpha:]].*'),ad_base.ABBR_STREET1) as score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
AND UTL_MATCH.jaro_winkler(REGEXP_SUBSTR(UNSEEDED.current_line1,'[[:alpha:]].*'),ad_base.ABBR_STREET1)>0.85
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM; 

UPDATE RESULTS58 SET STAGE= '58';

CREATE TABLE RESULTS58a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS58)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS58a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS58a Where UNSEEDED.ID = RESULTS58a.ID);
COMMIT;


CREATE TABLE RESULTS59 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  REGEXP_SUBSTR(UNSEEDED.current_line2,'[[:alpha:]].*') TEST_STREET,
  UTL_MATCH.jaro_winkler(REGEXP_SUBSTR(UNSEEDED.current_line2,'[[:alpha:]].*'),ad_base.ABBR_STREET1) as score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
AND UTL_MATCH.jaro_winkler(REGEXP_SUBSTR(UNSEEDED.current_line2,'[[:alpha:]].*'),ad_base.ABBR_STREET1)>0.85
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM; 

UPDATE RESULTS59 SET STAGE= '59';

CREATE TABLE RESULTS59a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS59)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS59a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS59a Where UNSEEDED.ID = RESULTS59a.ID);
COMMIT;
drop table "RESULTS59";

CREATE TABLE RESULTS60 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  REGEXP_SUBSTR(UNSEEDED.CURRENT_LINE3,'[[:alpha:]].*') TEST_STREET,
  UTL_MATCH.jaro_winkler(REGEXP_SUBSTR(UNSEEDED.current_line3,'[[:alpha:]].*'),ad_base.ABBR_STREET1) as score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
AND UTL_MATCH.jaro_winkler(REGEXP_SUBSTR(UNSEEDED.current_line3,'[[:alpha:]].*'),ad_base.ABBR_STREET1)>0.85
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM; 

UPDATE RESULTS60 SET STAGE= '60';

CREATE TABLE RESULTS60a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS60)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS60a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS60a Where UNSEEDED.ID = RESULTS60a.ID);
COMMIT;
drop table "RESULTS60";

CREATE TABLE RESULTS61 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  (length(UNSEEDED.ADDRESS_STRING)-
  (UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||ad_base.ABBR_STREET1||' '||AD_BASE.POST_TOWN)))
  /length(ad_base.ADDRESS_LINE_1||' '||ad_base.ABBR_STREET1||' '||AD_BASE.POST_TOWN) as score,
  UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_6=UNSEEDED.H3_6_p
AND UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||ad_base.ABBR_STREET1||' '||AD_BASE.POST_TOWN)>0.8
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM; 

UPDATE RESULTS61 SET STAGE= '61';

CREATE TABLE RESULTS61a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,str_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, STR_SCORE,ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS61)
WHERE SCORE = MAX_SCORE and str_score>0.8
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS61a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS61a Where UNSEEDED.ID = RESULTS61a.ID);
COMMIT;
drop table "RESULTS61";
 
 -----new bits
 create table word_test1 as  select UPRN,PARENT_UPRN,ID, UNSEEDED.STAGE,AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3) AS SCORE,
substr(UNSEEDED.ADDRESS_STRING,length(ad_base.ADDRESS_STRING_NOPC)-length(UNSEEDED.ADDRESS_STRING)) AS test
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
and SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3)>0.85
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[0-9]')=0
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(UNSEEDED.address_string ,ad_base.word_one,1,1)>0
and length(ad_base.word_one)>3
AND instr(UNSEEDED.address_string ,ad_base.word_two,1,1)>0
and length(ad_base.word_two)>3
AND instr(ad_base.address_string_nopc ,UNSEEDED.word_one,1,1)>0
and length(ad_base.word_one)>3
AND instr(ad_base.address_string_nopc ,UNSEEDED.word_two,1,1)>0
and length(ad_base.word_two)>3
and AD_BASE.ADD_NUM is null 
and UNSEEDED.ADD_NUM is null;

create table word_test2 as select UPRN,PARENT_UPRN,ID, UNSEEDED.STAGE,AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3) AS SCORE,
substr(UNSEEDED.ADDRESS_STRING,length(ad_base.ADDRESS_STRING_NOPC)-length(UNSEEDED.ADDRESS_STRING)) AS test
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
and SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3)>0.84
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[0-9]')=0
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m ||UNSEEDED.word_three_m,ad_base.word_one_m,1,1)>0
and length(ad_base.word_one)>3
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m ||UNSEEDED.word_three_m,ad_base.word_two_m,1,1)>0
and length(ad_base.word_two)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m ||ad_base.word_three_m,UNSEEDED.word_one_m,1,1)>0
and length(ad_base.word_one)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m ||ad_base.word_three_m,UNSEEDED.word_two_m,1,1)>0
and length(ad_base.word_two)>3
and AD_BASE.ADD_NUM is null 
and UNSEEDED.ADD_NUM is null;
--AND regex_like(ad_base.ADDRESS_LINE_3,UNSEEDED.address_string)

create table word_test3 as select UPRN,PARENT_UPRN,ID, UNSEEDED.STAGE,AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3) AS SCORE,
substr(UNSEEDED.ADDRESS_STRING,length(ad_base.ADDRESS_STRING_NOPC)-length(UNSEEDED.ADDRESS_STRING)) AS test
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
and UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3)>0.84
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[0-9]')=0
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_one_m ,ad_base.word_one_m,1,1)>0
and length(ad_base.word_one)>3
--AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m ,ad_base.word_two_m,1,1)>0
--and length(ad_base.word_two)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m ,UNSEEDED.word_one_m,1,1)>0
and length(ad_base.word_one)>3
--AND instr(ad_base.word_one_m||ad_base.word_two_m ,UNSEEDED.word_two_m,1,1)>0
--and length(ad_base.word_two)>3
and AD_BASE.ADD_NUM is null 
and UNSEEDED.ADD_NUM is null;


create table word_test4 as select UPRN,PARENT_UPRN,ID,UNSEEDED.STAGE, AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3) AS SCORE,
substr(UNSEEDED.ADDRESS_STRING,length(ad_base.ADDRESS_STRING_NOPC)-length(UNSEEDED.ADDRESS_STRING)) AS test
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
and UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3)>0.84
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[0-9]')=0
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m||UNSEEDED.word_three_m ||UNSEEDED.word_four_m,ad_base.word_one_m,1,1)>0
and length(ad_base.word_one)>3
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m||UNSEEDED.word_three_m||UNSEEDED.word_four_m ,ad_base.word_two_m,1,1)>0
and length(ad_base.word_two)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m||ad_base.word_three_m||ad_base.word_four_m ,UNSEEDED.word_one_m,1,1)>0
and length(ad_base.word_one)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m||ad_base.word_three_m||ad_base.word_four_m ,UNSEEDED.word_two_m,1,1)>0
and length(ad_base.word_two)>3
and AD_BASE.ADD_NUM is null 
and UNSEEDED.ADD_NUM is null;

create table word_test5 as select UPRN,PARENT_UPRN,ID,UNSEEDED.STAGE, AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.post_town,UNSEEDED.current_line1||' '||UNSEEDED.current_line3) AS SCORE,
substr(UNSEEDED.ADDRESS_STRING,length(ad_base.ADDRESS_STRING_NOPC)-length(UNSEEDED.ADDRESS_STRING)) AS test
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
and UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.post_town,UNSEEDED.current_line1||' '||UNSEEDED.current_line3)>0.84
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[0-9]')=0
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m||UNSEEDED.word_three_m ||UNSEEDED.word_four_m,ad_base.word_one_m,1,1)>0
and length(ad_base.word_one)>3
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m||UNSEEDED.word_three_m||UNSEEDED.word_four_m ,ad_base.word_two_m,1,1)>0
and length(ad_base.word_two)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m||ad_base.word_three_m||ad_base.word_four_m ,UNSEEDED.word_one_m,1,1)>0
and length(ad_base.word_one)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m||ad_base.word_three_m||ad_base.word_four_m ,UNSEEDED.word_two_m,1,1)>0
and length(ad_base.word_two)>3
and AD_BASE.ADD_NUM is null 
and UNSEEDED.ADD_NUM is null;

CREATE TABLE TEST_word_union AS 
select * from word_test1
union 
select * from word_test2
union
select * from word_test3
union 
select * from word_test4
union
select * from word_test5;
drop table "WORD_TEST1" ;
drop table "WORD_TEST2" ;
drop table "WORD_TEST3" ;
drop table "WORD_TEST4" ;
drop table "WORD_TEST5" ;
alter table "TEST_WORD_UNION" compress;

UPDATE TEST_WORD_UNION SET STAGE= '62';

CREATE TABLE RESULTS62a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM TEST_WORD_UNION)
WHERE SCORE = MAX_SCORE
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS62a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS62a Where UNSEEDED.ID = RESULTS62a.ID);
COMMIT;
drop table "TEST_WORD_UNION";
----more

create table test_one as select ID,STAGE,UPRN,PARENT_UPRN, AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_1,UNSEEDED.CURRENT_LINE2) AS SCORE 
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
AND regexp_INSTR(UNSEEDED.CURRENT_LINE1, '+[0-9]')>0
AND regexp_INSTR(UNSEEDED.CURRENT_LINE1, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(ad_base.ADDRESS_STRING_NOPC,UNSEEDED.CURRENT_LINE1,1,1)>0
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM;

create table test_two as select ID,STAGE,UPRN,PARENT_UPRN, AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_1,UNSEEDED.CURRENT_LINE2) AS SCORE
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
AND regexp_INSTR(UNSEEDED.CURRENT_LINE2, '+[0-9]')>0
AND regexp_INSTR(UNSEEDED.CURRENT_LINE2, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(ad_base.ADDRESS_STRING_NOPC,UNSEEDED.CURRENT_LINE2,1,1)>0
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM;

create table test_three as select ID,STAGE,UPRN,PARENT_UPRN, AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING ,
UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_1,UNSEEDED.CURRENT_LINE2) AS SCORE
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
AND regexp_INSTR(UNSEEDED.CURRENT_LINE3, '+[0-9]')>0
AND regexp_INSTR(UNSEEDED.CURRENT_LINE3, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(ad_base.ADDRESS_STRING_NOPC,UNSEEDED.CURRENT_LINE3,1,1)>0
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM;

create table test_four as select ID,STAGE,UPRN,PARENT_UPRN, AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_1,UNSEEDED.CURRENT_LINE2) AS SCORE
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
AND regexp_INSTR(UNSEEDED.CURRENT_LINE2, '+[0-9]')>0
AND regexp_INSTR(UNSEEDED.CURRENT_LINE2, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_1,UNSEEDED.CURRENT_LINE2)<3
AND UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_1,UNSEEDED.CURRENT_LINE2)>=0
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM;

create table test_five as select ID,STAGE,UPRN,PARENT_UPRN,AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_2,UNSEEDED.CURRENT_LINE2) AS SCORE
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
AND regexp_INSTR(UNSEEDED.CURRENT_LINE2, '+[0-9]')>0
AND regexp_INSTR(UNSEEDED.CURRENT_LINE2, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_2,UNSEEDED.CURRENT_LINE2)<3
AND UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_2,UNSEEDED.CURRENT_LINE2)>=0
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM;

create table test_six as select ID,STAGE,UPRN,PARENT_UPRN, AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_2,UNSEEDED.CURRENT_LINE1) AS SCORE
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
AND regexp_INSTR(UNSEEDED.CURRENT_LINE1, '+[0-9]')>0
AND regexp_INSTR(UNSEEDED.CURRENT_LINE1, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_2,UNSEEDED.CURRENT_LINE1)<3
AND UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_2,UNSEEDED.CURRENT_LINE1)>=0
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM;


create table test_seven as select ID,STAGE,UPRN,PARENT_UPRN, AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_1,UNSEEDED.CURRENT_LINE1) AS SCORE
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
AND regexp_INSTR(UNSEEDED.CURRENT_LINE1, '+[0-9]')=0
AND regexp_INSTR(UNSEEDED.CURRENT_LINE1, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_1,UNSEEDED.CURRENT_LINE1)<2
AND UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_1,UNSEEDED.CURRENT_LINE1)>=0
AND AD_BASE.ADD_NUM is null and UNSEEDED.ADD_NUM is null;

create table test_eight as select ID,STAGE,UPRN,PARENT_UPRN, AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1,UNSEEDED.CURRENT_LINE2) AS SCORE
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
AND regexp_INSTR(UNSEEDED.CURRENT_LINE2, '+[0-9]')=0
AND regexp_INSTR(UNSEEDED.CURRENT_LINE2, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_1,UNSEEDED.CURRENT_LINE2)<3
AND UTL_MATCH.EDIT_DISTANCE(ad_base.ADDRESS_LINE_1,UNSEEDED.CURRENT_LINE2)>=0
AND AD_BASE.ADD_NUM is null and UNSEEDED.ADD_NUM is null;

 CREATE TABLE TEST_union AS 
select * from test_one
union 
select * from test_two
union
select * from test_three
union 
select * from test_four
union
select * from test_five
union 
select * from test_six
union
select * from test_seven
union 
select * from test_eight;

drop table "TEST_ONE";  
drop table "TEST_TWO" ; 
drop table "TEST_THREE";  
drop table "TEST_FOUR";  
drop table "TEST_FIVE";  
drop table "TEST_SIX";  
drop table "TEST_SEVEN";
drop table "TEST_EIGHT"; 

alter table "TEST_UNION" compress;

UPDATE TEST_union SET STAGE= '63'; 
 
 CREATE TABLE RESULTS63a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM TEST_UNION)
WHERE SCORE = MAX_SCORE
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS63a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS63a Where UNSEEDED.ID = RESULTS63a.ID);
COMMIT;
drop table "TEST_UNION";
 
 
 create table word_test6 as  select ID, STAGE,UPRN,PARENT_UPRN,AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3) AS SCORE,
substr(UNSEEDED.ADDRESS_STRING,length(ad_base.ADDRESS_STRING_NOPC)-length(UNSEEDED.ADDRESS_STRING)) AS test
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
--and SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3)>0.7
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[0-9]')=0
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(UNSEEDED.address_string ,ad_base.word_one,1,1)>0
and length(ad_base.word_one)>3
AND instr(UNSEEDED.address_string ,ad_base.word_two,1,1)>0
and length(ad_base.word_two)>3
AND instr(ad_base.address_string_nopc ,UNSEEDED.word_one,1,1)>0
and length(ad_base.word_one)>3
AND instr(ad_base.address_string_nopc ,UNSEEDED.word_two,1,1)>0
and length(ad_base.word_two)>3
and AD_BASE.ADD_NUM =UNSEEDED.ADD_NUM;

create table word_test7 as select ID, STAGE,UPRN,PARENT_UPRN,AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3) AS SCORE,
substr(UNSEEDED.ADDRESS_STRING,length(ad_base.ADDRESS_STRING_NOPC)-length(UNSEEDED.ADDRESS_STRING)) AS test
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
and SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3)>0.55
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[0-9]')=0
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m ||UNSEEDED.word_three_m,ad_base.word_one_m,1,1)>0
and length(ad_base.word_one)>3
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m ||UNSEEDED.word_three_m,ad_base.word_two_m,1,1)>0
and length(ad_base.word_two)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m ||ad_base.word_three_m,UNSEEDED.word_one_m,1,1)>0
and length(ad_base.word_one)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m ||ad_base.word_three_m,UNSEEDED.word_two_m,1,1)>0
and length(ad_base.word_two)>3
and AD_BASE.ADD_NUM =UNSEEDED.ADD_NUM;
--AND regex_like(ad_base.ADDRESS_LINE_3,UNSEEDED.address_string)

create table word_test8 as select ID, STAGE,UPRN,PARENT_UPRN,AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3) AS SCORE,
substr(UNSEEDED.ADDRESS_STRING,length(ad_base.ADDRESS_STRING_NOPC)-length(UNSEEDED.ADDRESS_STRING)) AS test
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
and UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3)>0.84
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[0-9]')=0
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_one_m ,ad_base.word_one_m,1,1)>0
and length(ad_base.word_one)>3
--AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m ,ad_base.word_two_m,1,1)>0
--and length(ad_base.word_two)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m ,UNSEEDED.word_one_m,1,1)>0
and length(ad_base.word_one)>3
--AND instr(ad_base.word_one_m||ad_base.word_two_m ,UNSEEDED.word_two_m,1,1)>0
--and length(ad_base.word_two)>3
and AD_BASE.ADD_NUM =UNSEEDED.ADD_NUM;

create table word_test9 as select ID, STAGE,UPRN,PARENT_UPRN,AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3) AS SCORE,
substr(UNSEEDED.ADDRESS_STRING,length(ad_base.ADDRESS_STRING_NOPC)-length(UNSEEDED.ADDRESS_STRING)) AS test
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
--and UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.ADDRESS_LINE_3,UNSEEDED.current_line1||' '||UNSEEDED.current_line3)>0.84
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[0-9]')=0
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m||UNSEEDED.word_three_m ||UNSEEDED.word_four_m,ad_base.word_one_m,1,1)>0
and length(ad_base.word_one)>3
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m||UNSEEDED.word_three_m||UNSEEDED.word_four_m ,ad_base.word_two_m,1,1)>0
and length(ad_base.word_two)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m||ad_base.word_three_m||ad_base.word_four_m ,UNSEEDED.word_one_m,1,1)>0
and length(ad_base.word_one)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m||ad_base.word_three_m||ad_base.word_four_m ,UNSEEDED.word_two_m,1,1)>0
and length(ad_base.word_two)>3
and AD_BASE.ADD_NUM =UNSEEDED.ADD_NUM;

create table word_test10 as select ID, STAGE,UPRN,PARENT_UPRN,AD_BASE.ADDRESS_STRING_NOPC, UNSEEDED.ADDRESS_STRING,
SYS.UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.post_town,UNSEEDED.current_line1||' '||UNSEEDED.current_line3) AS SCORE,
substr(UNSEEDED.ADDRESS_STRING,length(ad_base.ADDRESS_STRING_NOPC)-length(UNSEEDED.ADDRESS_STRING)) AS test
from ad_base, UNSEEDED 
where AD_BASE.H3_6=UNSEEDED.H3_6_P 
--and UTL_MATCH.JARO_WINKLER(ad_base.ADDRESS_LINE_1||ad_base.post_town,UNSEEDED.current_line1||' '||UNSEEDED.current_line3)>0.84
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[0-9]')=0
--AND regexp_INSTR(UNSEEDED.ADDRESS_STRING, '+[A-Z]')>0
--AND UNSEEDED.CURRENT_LINE2 !=AD_BASE.POST_TOWN
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m||UNSEEDED.word_three_m ||UNSEEDED.word_four_m,ad_base.word_one_m,1,1)>0
and length(ad_base.word_one)>3
AND instr(UNSEEDED.word_one_m||UNSEEDED.word_two_m||UNSEEDED.word_three_m||UNSEEDED.word_four_m ,ad_base.word_two_m,1,1)>0
and length(ad_base.word_two)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m||ad_base.word_three_m||ad_base.word_four_m ,UNSEEDED.word_one_m,1,1)>0
and length(ad_base.word_one)>3
AND instr(ad_base.word_one_m||ad_base.word_two_m||ad_base.word_three_m||ad_base.word_four_m ,UNSEEDED.word_two_m,1,1)>0
and length(ad_base.word_two)>3
and AD_BASE.ADD_NUM =UNSEEDED.ADD_NUM;

CREATE TABLE TEST_word_union2 AS 
select * from word_test6
union 
select * from word_test7
union
select * from word_test8
union 
select * from word_test9
union
select * from word_test10;

alter table "TEST_WORD_UNION2" compress;
UPDATE TEST_word_union2 SET STAGE= '64'; 
 
 CREATE TABLE RESULTS64a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM TEST_word_UNION2)
WHERE SCORE = MAX_SCORE
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS64a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS64a Where UNSEEDED.ID = RESULTS64a.ID);
COMMIT;
drop table "TEST_WORD_UNION2";

drop table "WORD_TEST6";
drop table "WORD_TEST7";
drop table "WORD_TEST8";
drop table "WORD_TEST9";
drop table "WORD_TEST10";
 
CREATE TABLE RESULTS65 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  REGEXP_SUBSTR(UNSEEDED.current_line1,'[[:alpha:]].*') TEST_STREET,
  UTL_MATCH.jaro_winkler(REGEXP_SUBSTR(UNSEEDED.current_line1,'[[:alpha:]].*'),ad_base.ABBR_STREET1) as score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
AND UTL_MATCH.jaro_winkler(REGEXP_SUBSTR(UNSEEDED.current_line1,'[[:alpha:]].*'),ad_base.ABBR_STREET1)>0.85
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM; 

UPDATE RESULTS65 SET STAGE= '65';

CREATE TABLE RESULTS65a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS65)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS65a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS65a Where UNSEEDED.ID = RESULTS65a.ID);
COMMIT;
 
drop table "RESULTS65"; 
 
 CREATE TABLE RESULTS66 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  REGEXP_SUBSTR(UNSEEDED.current_line2,'[[:alpha:]].*') TEST_STREET,
  UTL_MATCH.jaro_winkler(REGEXP_SUBSTR(UNSEEDED.current_line2,'[[:alpha:]].*'),ad_base.ABBR_STREET1) as score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
AND UTL_MATCH.jaro_winkler(REGEXP_SUBSTR(UNSEEDED.current_line2,'[[:alpha:]].*'),ad_base.ABBR_STREET1)>0.85
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM; 

UPDATE RESULTS66 SET STAGE= '66';

CREATE TABLE RESULTS66a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS66)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS66a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS66a Where UNSEEDED.ID = RESULTS66a.ID);
COMMIT;
drop table "RESULTS66";
 
CREATE TABLE RESULTS67 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  REGEXP_SUBSTR(UNSEEDED.CURRENT_LINE3,'[[:alpha:]].*') TEST_STREET,
  UTL_MATCH.jaro_winkler(REGEXP_SUBSTR(UNSEEDED.current_line3,'[[:alpha:]].*'),ad_base.ABBR_STREET1) as score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
AND UTL_MATCH.jaro_winkler(REGEXP_SUBSTR(UNSEEDED.current_line3,'[[:alpha:]].*'),ad_base.ABBR_STREET1)>0.85
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM; 

UPDATE RESULTS67 SET STAGE= '67';

CREATE TABLE RESULTS67A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS67)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS67A
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS67a Where UNSEEDED.ID = RESULTS67a.ID);
COMMIT;
drop table "RESULTS67";
 
--CREATE TABLE RESULTS68 AS SELECT
--UNSEEDED.ID,
--UNSEEDED.STAGE,
--UNSEEDED.ADDRESS_STRING,
--UNSEEDED.ADD_NUM as in_num,
--ad_base.address_line_1,
--ad_base.address_line_2,
--UNSEEDED.current_line1,
--ad_base.ADD_NUM, 
--ad_base.UPRN,
--ad_base.PARENT_UPRN,
--ad_base.ADDRESS_STRING_NOPC,
--UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||ad_base.ABBR_STREET1||' '||AD_BASE.POST_TOWN)as score,
--UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
--ad_base.ABBR_STREET1
--FROM UNSEEDED,ad_base
--WHERE ad_base.h3_6=UNSEEDED.H3_6_p
--AND UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||ad_base.ABBR_STREET1||' '||AD_BASE.POST_TOWN)>0.8
--AND  UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1) >.8
--AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM; 

--UPDATE RESULTS68 SET STAGE= '68';

--CREATE TABLE RESULTS68a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,str_SCORE,COUNT_P_UPRN FROM(
--SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, STR_SCORE,ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
--DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
--FROM RESULTS68)
--WHERE SCORE = MAX_SCORE and str_score>0.8
--AND COUNT_P_UPRN =1
--ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
--ALTER TABLE RESULTS68a
--COMPRESS;

--DELETE FROM UNSEEDED
--WHERE EXISTS( SELECT id FROM RESULTS68a Where UNSEEDED.ID = RESULTS68a.ID);
--COMMIT;
--drop table "RESULTS68";

CREATE TABLE RESULTS69 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' ' ||ADDRESS_LINE_3||' '||POST_TOWN) as score,
  UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
AND UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' ' ||ADDRESS_LINE_3||' '||POST_TOWN)>0.75
AND UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1)>0.8
AND LENGTH(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','')))>4
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM; 


UPDATE RESULTS69 SET STAGE= '69';

CREATE TABLE RESULTS69a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,str_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, STR_SCORE,ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS69)
WHERE SCORE = MAX_SCORE and str_score>0.8 AND MAX_SCORE >0.8
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS69a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS69a Where UNSEEDED.ID = RESULTS69a.ID);
COMMIT;
drop table "RESULTS69";


CREATE TABLE RESULTS70 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
   UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
   UTL_MATCH.edit_distance(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '[[:space:]]','') ,regexp_REPLACE(ad_base.ADDRESS_STRING_NOPC, '[[:space:]]','')) as score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_6=UNSEEDED.H3_6_p 
AND UTL_MATCH.edit_distance(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '[[:space:]]','') ,regexp_REPLACE(ad_base.ADDRESS_STRING_NOPC, '[[:space:]]','')) <5
--AND UTL_MATCH.edit_distance(regexp_REPLACE(ad_base.ADDRESS_STRING_NOPC, '[[:space:]]',''),regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '[[:space:]]','') ) <5
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM; 


UPDATE RESULTS70 SET STAGE= '70';

CREATE TABLE RESULTS70a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,min_SCORE,str_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, STR_SCORE,ADDRESS_STRING_NOPC, SCORE,min(SCORE) OVER (PARTITION BY ID) AS Min_SCORE,
mAX(str_SCORE) OVER (PARTITION BY ID) AS MAX_str_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS70)
WHERE  score=min_score
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS70a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS70a Where UNSEEDED.ID = RESULTS70a.ID);
COMMIT;
drop table "RESULTS70";

CREATE TABLE RESULTS71 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' ' ||ADDRESS_LINE_3||' '||POST_TOWN) as score,
  UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
AND UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' ' ||ADDRESS_LINE_3||' '||POST_TOWN)>0.75
AND UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1)>0.8
AND LENGTH(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','')))>4
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM; 


UPDATE RESULTS71 SET STAGE= '71';

CREATE TABLE RESULTS71a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,str_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, STR_SCORE,ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS71)
WHERE str_score>0.8 AND MAX_SCORE >0.8
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS71a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS71a Where UNSEEDED.ID = RESULTS71a.ID);
COMMIT;
drop table "RESULTS71";


CREATE TABLE RESULTS72 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
UNSEEDED.WORD_ONE,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
   UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
   UTL_MATCH.edit_distance(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '[[:space:]]','') ,regexp_REPLACE(ad_base.ADDRESS_STRING_NOPC, '[[:space:]]','')) as score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_6=UNSEEDED.H3_6_p 
AND UTL_MATCH.edit_distance(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '[[:space:]]','') ,regexp_REPLACE(ad_base.ADDRESS_STRING_NOPC, '[[:space:]]',''))<4
AND UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1)>0.65
AND AD_BASE.ADD_NUM=UNSEEDED.ADD_NUM; 


UPDATE RESULTS72 SET STAGE= '72';

CREATE TABLE RESULTS72a AS SELECT DISTINCT ID,STAGE,UPRN,WORD_ONE,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,min_SCORE,str_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,WORD_ONE,PARENT_UPRN, ADDRESS_STRING, STR_SCORE,ADDRESS_STRING_NOPC, SCORE,min(SCORE) OVER (PARTITION BY ID) AS Min_SCORE,
mAX(str_SCORE) OVER (PARTITION BY ID) AS MAX_str_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS72)
WHERE SCORE=MIN_SCORE AND STR_SCORE=MAX_STR_SCORE AND LENGTH(WORD_ONE)-SCORE>3
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS72a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS72a Where UNSEEDED.ID = RESULTS72a.ID);
COMMIT;
drop table "RESULTS72";


CREATE TABLE RESULTS73 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' ' ||ADDRESS_LINE_2||' '||POST_TOWN) as score,
  UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
AND UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' ' ||ADDRESS_LINE_2||' '||POST_TOWN)>0.8
AND UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1)>0.8
--AND LENGTH(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','')))>4
AND (ad_base.BUILD_NO=UNSEEDED.ADD_NUM OR (AD_BASE.SUB_UNIT=UNSEEDED.ADD_NUM)); 


UPDATE RESULTS73 SET STAGE= '73';

CREATE TABLE RESULTS73A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,str_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, STR_SCORE,ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS73)
WHERE SCORE = MAX_SCORE and str_score>0.85 AND MAX_SCORE >0.8
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS73A
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS73A Where UNSEEDED.ID = RESULTS73a.ID);
COMMIT;
drop table "RESULTS73";

CREATE TABLE RESULTS74 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||POST_TOWN) as score,
  UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
--AND UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||POST_TOWN)>0.8
AND INSTR(ad_base.ABBR_STREET1,TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),1,1)>0
--AND LENGTH(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','')))>4
AND ad_base.BUILD_NO=UNSEEDED.ADD_NUM AND UNSEEDED.BUILD_NO IS NULL;

CREATE TABLE RESULTS75 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||POST_TOWN) as score,
  UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE2, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
--AND UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||POST_TOWN)>0.8
AND INSTR(ad_base.ABBR_STREET1,TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE2, '+[0-9]','') ),1,1)>0
AND LENGTH(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','')))<4
AND ad_base.BUILD_NO=UNSEEDED.ADD_NUM AND UNSEEDED.BUILD_NO IS NULL;

CREATE TABLE union3 AS 
select * from results74
union 
select * from results75;

UPDATE UNION3 SET STAGE= '74';

CREATE TABLE RESULTS74A AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,str_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, STR_SCORE,ADDRESS_STRING_NOPC, SCORE,mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM union3)
WHERE SCORE = MAX_SCORE 
--and str_score>0.85 AND MAX_SCORE >0.8
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS74A
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS74A Where UNSEEDED.ID = RESULTS74a.ID);
COMMIT;
drop table "UNION3";
drop table "RESULTS74";
drop table "RESULTS75";
--up to here

CREATE TABLE RESULTS76 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
UNSEEDED.ADD_NUM as in_num2,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||POST_TOWN) as score,
  UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
--AND UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||POST_TOWN)>0.9
--AND ad_base.ADDRESS_LINE_2=TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') )
AND AD_BASE.WORD_ONE=UNSEEDED.WORD_ONE
AND UTL_MATCH.JARO_WINKLER(AD_BASE.WORD_TWO,UNSEEDED.WORD_TWO)>0.8
AND UTL_MATCH.JARO_WINKLER(AD_BASE.DESCRIPTION,TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','')))>0.8;

UPDATE results76 SET STAGE= '75';

CREATE TABLE RESULTS75a AS SELECT DISTINCT ID,in_num,in_num2,add_num,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,str_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN,in_num,in_num2,add_num, ADDRESS_STRING, STR_SCORE,ADDRESS_STRING_NOPC, SCORE,
mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
mAX(STR_SCORE) OVER (PARTITION BY ID) AS MAX_STR_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM results76)
WHERE SCORE = MAX_SCORE AND STR_SCORE=MAX_STR_SCORE
and add_num=trim(in_num) or add_num=trim(in_num2)
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS75a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS75a Where UNSEEDED.ID = RESULTS75a.ID);
COMMIT;

CREATE TABLE RESULTS77 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
UNSEEDED.ADD_NUM as in_num2,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||POST_TOWN) as score,
  UTL_MATCH.jaro_winkler(TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') ),ad_base.ABBR_STREET1) as str_score,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
--AND UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||POST_TOWN)>0.8
--AND ad_base.ADDRESS_LINE_2=TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE1, '+[0-9]','') )
AND AD_BASE.WORD_ONE=UNSEEDED.WORD_ONE
AND UTL_MATCH.JARO_WINKLER(AD_BASE.WORD_TWO,UNSEEDED.WORD_TWO)>0.8
AND UTL_MATCH.JARO_WINKLER(AD_BASE.WORD_THREE,UNSEEDED.WORD_THREE)>0.8
AND UTL_MATCH.JARO_WINKLER(AD_BASE.DESCRIPTION,TRIM(regexp_REPLACE(UNSEEDED.CURRENT_LINE2, '+[0-9]','')))>0.8;

UPDATE RESULTS77 SET STAGE= '77';

CREATE TABLE RESULTS76a AS SELECT DISTINCT ID,in_num,in_num2,add_num,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,str_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN,in_num,in_num2,add_num, ADDRESS_STRING, STR_SCORE,ADDRESS_STRING_NOPC, SCORE,
mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
mAX(STR_SCORE) OVER (PARTITION BY ID) AS MAX_STR_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS77)
WHERE SCORE = MAX_SCORE AND STR_SCORE=MAX_STR_SCORE
and add_num=trim(in_num) or add_num=trim(in_num2)
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS76a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS76a Where UNSEEDED.ID = RESULTS76a.ID);
COMMIT;

drop table "RESULTS76";
drop table "RESULTS77";

CREATE TABLE RESULTS78 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
UNSEEDED.ADD_NUM as in_num2,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
ad_base.build_no,
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  UTL_MATCH.edit_distance(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_STRING_NOPC) as score,
  UNSEEDED.range_lower,
  UNSEEDED.range_upper,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
and instr(UNSEEDED.address_string,ad_base.abbr_street1,1,1)>0
AND( ad_base.build_no between UNSEEDED.range_lower and UNSEEDED.range_upper 
and UNSEEDED.range_upper is not null)
AND (MOD ( regexp_REPLACE(UNSEEDED.range_lower, '+[0-9]',''),2) = MOD(regexp_REPLACE(AD_BASE.BUILD_NO, '+[0-9]',''),2) )

AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.ADD_STRING_WORKING,1,1)>0;

CREATE TABLE RESULTS78_2 AS SELECT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
UNSEEDED.ADD_NUM as in_num2,
ad_base.address_line_1,
ad_base.address_line_2,
UNSEEDED.current_line1,
ad_base.ADD_NUM, 
ad_base.build_no,
  ad_base.UPRN,
  ad_base.PARENT_UPRN,
  ad_base.ADDRESS_STRING_NOPC,
  UTL_MATCH.edit_distance(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_STRING_NOPC) as score,
  UNSEEDED.range_lower,
  UNSEEDED.range_upper,
  ad_base.ABBR_STREET1
FROM UNSEEDED,ad_base
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
--AND UTL_MATCH.jaro_winkler(UNSEEDED.ADDRESS_STRING,ad_base.ADDRESS_LINE_1||' '||POST_TOWN)>0.8
and instr(UNSEEDED.address_string,ad_base.abbr_street1,1,1)>0
AND (ad_base.build_no between UNSEEDED.range_lower2 and UNSEEDED.range_upper2 and UNSEEDED.range_upper2 is not null)
--AND MOD ( UNSEEDED.range_lower,2) = MOD(AD_BASE.BUILD_NO,2)
AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.ADD_STRING_WORKING,1,1)>0;

UPDATE RESULTS78 SET STAGE= '78';
UPDATE RESULTS78_2 SET STAGE= '78';

CREATE TABLE union4 AS 
select * from results78
union 
select * from results78_2;

drop table "RESULTS78";
drop table "RESULTS78_2";

CREATE TABLE RESULTS78a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,
mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM union4)
WHERE SCORE = MAX_SCORE AND COUNT_P_uprn =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS78a COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS78a Where UNSEEDED.ID = RESULTS78a.ID);
COMMIT;

drop table "UNION4";

CREATE TABLE RESULTS79 AS SELECT
ID,
UNSEEDED.STAGE,
ad_base.UPRN,
ad_base.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
UNSEEDED.ADDRESS_STRING,
substr(UNSEEDED.ADDRESS_STRING,greatest(-length(AD_BASE.ADDRESS_STRING_NOPC)),length( UNSEEDED.ADDRESS_STRING))  AS TEST,
TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '[A-Z]','')) AS TEST_NUM,
UTL_MATCH.JARO_WINKLER(UNSEEDED.ADDRESS_STRING,substr(UNSEEDED.ADDRESS_STRING,-length(AD_BASE.ADDRESS_STRING_NOPC),length( UNSEEDED.ADDRESS_STRING)) ) AS SCORE
FROM UNSEEDED, AD_BASE
WHERE ad_base.h3_10=UNSEEDED.H3_10_p 
AND TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '[A-Z]','') )=AD_BASE.ADD_NUM
AND INSTR(AD_BASE.ADDRESS_STRING_NOPC,UNSEEDED.ADD_STRING_WORKING,1,1)>0;

UPDATE RESULTS79 SET STAGE= '79';

CREATE TABLE RESULTS79a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,
mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS79)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS79a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS79a Where UNSEEDED.ID = RESULTS79a.ID);
COMMIT;

drop table "RESULTS79";

CREATE TABLE RESULTS80 AS SELECT
ID,
UNSEEDED.STAGE,
ad_base.UPRN,
ad_base.PARENT_UPRN,
AD_BASE.ADDRESS_LINE_1,
AD_BASE.ADDRESS_STRING_NOPC,
UNSEEDED.ADDRESS_STRING,
substr(UNSEEDED.ADDRESS_STRING,greatest(-length(AD_BASE.ADDRESS_STRING_NOPC)),length( UNSEEDED.ADDRESS_STRING))  AS TEST,
TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '[A-Z]','')) AS TEST_NUM,
UTL_MATCH.JARO_WINKLER(UNSEEDED.ADDRESS_STRING,substr(UNSEEDED.ADDRESS_STRING,-length(AD_BASE.ADDRESS_STRING_NOPC),length( UNSEEDED.ADDRESS_STRING)) ) AS SCORE
FROM UNSEEDED, AD_BASE
WHERE ad_base.h3_7=UNSEEDED.H3_7_p 
and length(ad_base.address_line_1)>4
AND INSTR(UNSEEDED.ADD_STRING_WORKING,AD_BASE.ADDRESS_LINE_1,1,1)>0;

UPDATE RESULTS80 SET STAGE= '80';

CREATE TABLE RESULTS80a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,
mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS80)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS80a
COMPRESS;

DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS80a Where UNSEEDED.ID = RESULTS80a.ID);
COMMIT;

drop table "RESULTS80";

CREATE TABLE RESULTS81 AS SELECT
ID,
UNSEEDED.STAGE,
ad_base.UPRN,
ad_base.PARENT_UPRN,
UNSEEDED.ADD_STRING_working,
ad_base.build_no,UNSEEDED.build_no as build_in,
AD_BASE.ADDRESS_STRING_NOPC,
UNSEEDED.ADDRESS_STRING,
substr(UNSEEDED.ADDRESS_STRING,greatest(-length(AD_BASE.ADDRESS_STRING_NOPC)),length( UNSEEDED.ADDRESS_STRING))  AS TEST,
TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '[A-Z]','')) AS TEST_NUM,
--UTL_MATCH.JARO_WINKLER(UNSEEDED.ADDRESS_STRING,substr(UNSEEDED.ADDRESS_STRING,-length(AD_BASE.ADDRESS_STRING_NOPC),length( UNSEEDED.ADDRESS_STRING)) ) 
UTL_MATCH.JARO_WINKLER(UNSEEDED.ADD_STRING_working,substr(UNSEEDED.ADDRESS_STRING,-length(AD_BASE.ADDRESS_STRING_NOPC),length( UNSEEDED.ADDRESS_STRING)) )AS SCORE
FROM UNSEEDED, AD_BASE
WHERE ad_base.h3_6=UNSEEDED.H3_6_p 
and ad_base.build_no=UNSEEDED.build_no 
--or UNSEEDED.build_no BETWEEN AD_BASE.range_lower and ad_base.range_upper)
and instr(UNSEEDED.address_string,ad_base.description,1,1)>0 
--AND instr(AD_BASE.ADDRESS_string_nopc,UNSEEDED.word_two,1,1)>0
--and instr(AD_BASE.ADDRESS_string_nopc,trim(UNSEEDED.word_two),1,1)>0
and UTL_MATCH.JARO_WINKLER(UNSEEDED.ADD_STRING_working,substr(UNSEEDED.ADDRESS_STRING,-length(AD_BASE.ADDRESS_STRING_NOPC),length( UNSEEDED.ADDRESS_STRING)) )>0.61;
 --and instr(UNSEEDED.current_line3,ad_base.post_town,1,1)>0;
 
 UPDATE RESULTS81 SET STAGE= '81';

CREATE TABLE RESULTS81a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,
mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS81)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS81a
COMPRESS;

 DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS81a Where UNSEEDED.ID = RESULTS81a.ID);
COMMIT;

drop table "RESULTS81";


CREATE TABLE RESULTS82 AS SELECT
ID,
UNSEEDED.STAGE,
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
UNSEEDED.ADDRESS_STRING,
substr(UNSEEDED.ADDRESS_STRING,greatest(-length(AD_BASE.ADDRESS_STRING_NOPC)),length( UNSEEDED.ADDRESS_STRING))  AS TEST,
TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '[A-Z]','')) AS TEST_NUM,
UTL_MATCH.JARO_WINKLER(UNSEEDED.ADDRESS_STRING,substr(UNSEEDED.ADDRESS_STRING,-length(AD_BASE.ADDRESS_STRING_NOPC),length( UNSEEDED.ADDRESS_STRING)) ) AS SCORE
FROM UNSEEDED, AD_BASE
WHERE  UNSEEDED.H3_8_p=AD_BASE.h3_8
--AND UTL_MATCH.JARO_WINKLER(UNSEEDED.ADDRESS_STRING,substr(UNSEEDED.ADDRESS_STRING,-length(AD_BASE.ADDRESS_STRING_NOPC),length( UNSEEDED.ADDRESS_STRING)) ) >0.7
AND INSTR(UNSEEDED.ADDRESS_STRING,AD_BASE.abbr_street1,1,1)>0
AND instr(AD_BASE.address_string_nopc,UNSEEDED.add_string_working,1,1)>0
and length(ad_base.build_no)=length(UNSEEDED.build_no)
AND ((instr(AD_BASE.address_string_nopc,TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '[A-Z]','')),1,1)>0) or (ad_base.build_no between UNSEEDED.range_lower and UNSEEDED.range_upper and UNSEEDED.range_upper is not null)
or (UNSEEDED.build_no between ad_base.range_lower and ad_base.range_upper and UNSEEDED.range_upper is not null));


UPDATE RESULTS82 SET STAGE= 82;

CREATE TABLE RESULTS82a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,
mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS82)
WHERE SCORE = MAX_SCORE 
AND COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS82a
COMPRESS;

 DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS82a Where UNSEEDED.ID = RESULTS82a.ID);
COMMIT;

drop table "RESULTS82";

CREATE TABLE RESULTS83 AS SELECT
ID,
UNSEEDED.STAGE,
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.LATITUDE,
AD_BASE.LONGITUDE,
AD_BASE.ADDRESS_STRING_NOPC,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.CURRENT_LINE3,
substr(UNSEEDED.ADDRESS_STRING,greatest(-length(AD_BASE.ADDRESS_STRING_NOPC)),length( UNSEEDED.ADDRESS_STRING))  AS TEST,
substr(UNSEEDED.ADDRESS_STRING,greatest(-length(UNSEEDED.ADDRESS_STRING)),length( UNSEEDED.CURRENT_LINE3))  AS CUTOFF3,
TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, '[A-Z]','')) AS TEST_NUM,
TRIM(regexp_REPLACE(UNSEEDED.ADDRESS_STRING, UNSEEDED.SUB_UNIT,'')) AS NO_NAME,
regexp_replace(AD_BASE.ABBR_STREET1, '(((\w+)\s){1}).*', '\1'  ) AS STR_ONE,
UTL_MATCH.JARO_WINKLER(UNSEEDED.ADDRESS_STRING,substr(UNSEEDED.ADDRESS_STRING,-length(AD_BASE.ADDRESS_STRING_NOPC),length( UNSEEDED.ADDRESS_STRING)) ) AS SCORE
FROM UNSEEDED, AD_BASE
WHERE  UNSEEDED.H3_7_p=AD_BASE.h3_7--and (length(ad_base.build_no) = length(UNSEEDED.range_lower2) or length(ad_base.build_no) = length(UNSEEDED.range_upper2))
and ((UNSEEDED.build_no BETWEEN  ad_base.range_lower2 AND ad_base.range_upper2 and UNSEEDED.range_upper2 is not null)
OR (AD_BASE.build_no=TO_CHAR(UNSEEDED.range_upper) and UNSEEDED.range_upper is not null) 
OR AD_BASE.build_no=TO_CHAR(UNSEEDED.range_LOWer) )
AND INSTR(UNSEEDED.ADDRESS_STRING,regexp_replace(AD_BASE.ABBR_STREET1, '(((\w+)\s){1}).*', '\1'  ),1,1)>0
AND INSTR(UNSEEDED.ADDRESS_STRING,regexp_replace(AD_BASE.ABBR_STREET1, '(((\w+)\s){2}).*', '\1'  ),1,1)>0;
--83 not finished partion by lat n long?

UPDATE RESULTS83 SET STAGE= 83;

CREATE TABLE RESULTS83a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,
--mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
FROM RESULTS83)
WHERE 
--SCORE = MAX_SCORE 
 COUNT_P_UPRN =1
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS83a
COMPRESS;

 DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS83a Where UNSEEDED.ID = RESULTS83a.ID);
COMMIT;

drop table "RESULTS83";

CREATE TABLE RESULTS84 AS SELECT
ID,
UNSEEDED.STAGE,
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
UNSEEDED.ADDRESS_STRING,
substr(UNSEEDED.address_string, REGEXP_inSTR(UNSEEDED.address_string,'[0-9]+') ,length(UNSEEDED.address_string))as test1,
UTL_MATCH.JARO_WINKLER(substr(UNSEEDED.address_string, REGEXP_inSTR(UNSEEDED.address_string,'[0-9]+') ),AD_BASE.ADDRESS_STRING_NOPC ) as score
FROM UNSEEDED, AD_BASE
WHERE  UNSEEDED.H3_6_p=AD_BASE.h3_6
and UTL_MATCH.JARO_WINKLER(substr(UNSEEDED.address_string, REGEXP_inSTR(UNSEEDED.address_string,'[0-9]+') ),AD_BASE.ADDRESS_STRING_NOPC ) >0.6

and ((UNSEEDED.build_no BETWEEN  ad_base.range_lower2 AND ad_base.range_upper2 and UNSEEDED.range_upper2 is not null)
or (AD_BASE.BUILD_NO BETWEEN UNSEEDED.RANGE_LOWER AND UNSEEDED.RANGE_UPPER and UNSEEDED.range_upper is not null)
OR (AD_BASE.build_no=TO_CHAR(UNSEEDED.range_upper) and UNSEEDED.range_upper is not null) 
OR AD_BASE.build_no=TO_CHAR(UNSEEDED.range_LOWer) )
AND INSTR(UNSEEDED.ADDRESS_STRING,regexp_replace(AD_BASE.ABBR_STREET1, '(((\w+)\s){1}).*', '\1'  ),1,1)>0
AND INSTR(UNSEEDED.ADDRESS_STRING,regexp_replace(AD_BASE.ABBR_STREET1, '(((\w+)\s){2}).*', '\1'  ),1,1)>0;

UPDATE RESULTS84 SET STAGE= 84;

CREATE TABLE RESULTS84a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,
mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
--DENSE_RANK() OVER(PARTITION BY ID ORDER BY ADDRESS_STRING_NOPC) AS COUNT_ADDRESS_STRING_NOPC
FROM RESULTS84)
WHERE 
SCORE = MAX_SCORE 
and ( COUNT_P_UPRN =1 )
--or COUNT_ADDRESS_STRING_NOPC=1)
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS84a
COMPRESS;

 DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS84a Where UNSEEDED.ID = RESULTS84a.ID);
COMMIT;

drop table "RESULTS84";

CREATE TABLE RESULTS85 AS SELECT
ID,
UNSEEDED.STAGE,
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
UNSEEDED.ADDRESS_STRING,
substr(UNSEEDED.address_string, REGEXP_inSTR(UNSEEDED.address_string,'[0-9]+') ,length(UNSEEDED.address_string))as test1,
UTL_MATCH.JARO_WINKLER(substr(UNSEEDED.address_string, REGEXP_inSTR(UNSEEDED.address_string,'[0-9]+') ),AD_BASE.ADDRESS_STRING_NOPC ) as score
FROM UNSEEDED, AD_BASE
WHERE  UNSEEDED.H3_8_p=AD_BASE.h3_8
and UTL_MATCH.JARO_WINKLER(TRIM(substr(UNSEEDED.address_string, REGEXP_inSTR(UNSEEDED.address_string,'[0-9]+') )),AD_BASE.ADDRESS_STRING_NOPC ) >0.88
and 
((UNSEEDED.build_no BETWEEN  ad_base.range_lower2 AND ad_base.range_upper2 and UNSEEDED.range_upper2 is not null)
OR (AD_BASE.BUILD_NO BETWEEN UNSEEDED.RANGE_LOWER AND UNSEEDED.RANGE_UPPER and UNSEEDED.range_upper is not null)
OR (AD_BASE.build_no=TO_CHAR(UNSEEDED.range_upper) and UNSEEDED.range_upper is not null )
OR AD_BASE.build_no=TO_CHAR(UNSEEDED.range_LOWer)) ;

UPDATE RESULTS85 SET STAGE= 85;

CREATE TABLE RESULTS85a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,
mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
--DENSE_RANK() OVER(PARTITION BY ID ORDER BY ADDRESS_STRING_NOPC) AS COUNT_ADDRESS_STRING_NOPC
FROM RESULTS85)
WHERE 
SCORE = MAX_SCORE 
and ( COUNT_P_UPRN =1 )
--or COUNT_ADDRESS_STRING_NOPC=1)
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;
ALTER TABLE RESULTS85a
COMPRESS;

drop table "RESULTS85" ;

 DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS85a Where UNSEEDED.ID = RESULTS85a.ID);
COMMIT;

CREATE TABLE RESULTS86 AS SELECT
ID,
UNSEEDED.STAGE,
AD_BASE.UPRN,
AD_BASE.PARENT_UPRN,
AD_BASE.ADDRESS_STRING_NOPC,
AD_BASE.LATITUDE,
AD_BASE.LONGITUDE,
UNSEEDED.ADDRESS_STRING,
substr(UNSEEDED.address_string, REGEXP_inSTR(UNSEEDED.address_string,'[0-9]+') ,length(UNSEEDED.address_string))as test1,
UTL_MATCH.JARO_WINKLER(substr(UNSEEDED.address_string, REGEXP_inSTR(UNSEEDED.address_string,'[0-9]+') ),AD_BASE.ADDRESS_STRING_NOPC ) as score
FROM UNSEEDED, AD_BASE
WHERE  UNSEEDED.H3_10_p=AD_BASE.h3_10
and UTL_MATCH.JARO_WINKLER(TRIM(substr(UNSEEDED.address_string, REGEXP_inSTR(UNSEEDED.address_string,'[0-9]+') )),AD_BASE.ADDRESS_STRING_NOPC ) >0.8
and ((UNSEEDED.build_no BETWEEN  ad_base.range_lower2 AND ad_base.range_upper2 and UNSEEDED.range_upper2 is not null)
and instr(address_string,ad_base.abbr_street1,1,1)>0
OR (AD_BASE.BUILD_NO BETWEEN UNSEEDED.RANGE_LOWER AND UNSEEDED.RANGE_UPPER and UNSEEDED.range_upper is not null)
OR (AD_BASE.build_no=TO_CHAR(UNSEEDED.range_upper) and UNSEEDED.range_upper is not null) 
OR AD_BASE.build_no=TO_CHAR(UNSEEDED.range_LOWer));

UPDATE RESULTS86 SET STAGE= 86;

CREATE TABLE RESULTS86a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE,
mAX(SCORE) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
--DENSE_RANK() OVER(PARTITION BY ID ORDER BY ADDRESS_STRING_NOPC) AS COUNT_ADDRESS_STRING_NOPC
FROM RESULTS86)
WHERE 
SCORE = MAX_SCORE 
and ( COUNT_P_UPRN =1 )
--or COUNT_ADDRESS_STRING_NOPC=1)
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS86a COMPRESS;

 
drop table "RESULTS86";

 DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS86a Where UNSEEDED.ID = RESULTS86a.ID);
COMMIT;

create table results87 as SELECT DISTINCT
UNSEEDED.ID,
UNSEEDED.STAGE,
UNSEEDED.ADDRESS_STRING,
UNSEEDED.ADD_NUM as in_num,
AD_BASE.ADD_NUM, 
  AD_BASE.UPRN,
  AD_BASE.PARENT_UPRN,
  AD_BASE.ADDRESS_STRING_NOPC,
  (length(TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)) - UTL_MATCH.EDIT_DISTANCE(AD_BASE.ADDRESS_STRING_NOPC,
  TRIM(LEADING FROM UNSEEDED.ADDRESS_STRING)))/length(AD_BASE.ADDRESS_STRING_NOPC) AS SCORE1
FROM UNSEEDED,AD_BASE
WHERE AD_BASE.H3_6=UNSEEDED.H3_6_P
and (UNSEEDED.build_no BETWEEN  ad_base.range_lower AND ad_base.range_upper and UNSEEDED.range_upper is not null)
AND INSTR(UNSEEDED.CURRENT_LINE2 ,AD_BASE.DESCRIPTION,1,1)>0;

UPDATE RESULTS87 SET STAGE= 87;

CREATE TABLE RESULTS87a AS SELECT DISTINCT ID,STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC,SCORE1,MAX_SCORE,COUNT_P_UPRN FROM(
SELECT ID, STAGE,UPRN,PARENT_UPRN, ADDRESS_STRING, ADDRESS_STRING_NOPC, SCORE1,
mAX(SCORE1) OVER (PARTITION BY ID) AS MAX_SCORE,
DENSE_RANK() OVER(PARTITION BY ID ORDER BY PARENT_UPRN) AS COUNT_P_UPRN
--DENSE_RANK() OVER(PARTITION BY ID ORDER BY ADDRESS_STRING_NOPC) AS COUNT_ADDRESS_STRING_NOPC
FROM RESULTS87)
WHERE 
SCORE1 = MAX_SCORE 
and ( COUNT_P_UPRN =1 )
--or COUNT_ADDRESS_STRING_NOPC=1)
ORDER BY ID, ADDRESS_STRING, ADDRESS_STRING_NOPC;

ALTER TABLE RESULTS87a COMPRESS;

 
drop table "RESULTS87";

 DELETE FROM UNSEEDED
WHERE EXISTS( SELECT id FROM RESULTS87a Where UNSEEDED.ID = RESULTS87a.ID);
COMMIT;

--
--AND INSTR(TRIM(UNSEEDED.ADDRESS_STRING),regexp_replace(AD_BASE.ABBR_STREET1, '(((\w+)\s){1}).*', '\1'  ),1,1)>0
--AND INSTR(UNSEEDED.ADDRESS_STRING,regexp_replace(AD_BASE.ABBR_STREET1, '(((\w+)\s){2}).*', '\1'  ),1,1)>0;
-- olde method floor/apartment - new 0-1500
-- stumped you just have ot know this sort of thing.

--addresses expressed as a range 117-120 new street but incoming == 118 new street
--possiblyt use coordinates to aggregate a match

--swamped by too much sub unit noise on incomgin for addressbase reference 
---match from right hand side possibly

--TOWER BLOCK / name NUMBERING CHANGES
--140 CHARLES STREET = LOMOND HOUSE
--150 CHARLES STREET = NEVIS HOUSE
--160 CHARLES STREET = CAMPSIE HOUSE
---------------------------------------
         --aggregate results--
---------------------------------------
--CREATE MATERIALIZED VIEW seeded_result
--BUILD IMMEDIATE
--REFRESH FORCE


CREATE TABLE UPRNSEEDING
AS
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from resultsa
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results1a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results2a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results3a
union
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results3aa
union
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results4a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results5a 
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results6a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results7a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results8a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results9a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from resultS10a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results11a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from resultS12a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from resultS13a
union
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results14a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results15a
union 
select ID,STAGE,UPRN, parent_uprn , ADDRESS_STRING, ADDRESS_STRING_NOPC from results16a
union  
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results17a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results18a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results19a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results20a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results21a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results22a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results23a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results24a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results25a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results26a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results27a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results28a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results29a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results30a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results31a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results32a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results33a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results34a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results35a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results36a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results37a
union 
--select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results38a
--union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results39a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results40a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results41a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results42a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results43a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results44a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results45a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results46a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results47a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results48a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results49a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results50a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results51a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results52a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results53a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results54a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results55a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results57a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results58a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results59a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results60a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results61a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results62a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results63a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results64a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results65a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results66a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results67a
union 
--select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results68a
--union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results69a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results70a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results71a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results72a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results73a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results74a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results75a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results76a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results78a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results79a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results80a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results81a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results82a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results83a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results84a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results85a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results86a
union 
select ID,STAGE,UPRN, parent_uprn, ADDRESS_STRING, ADDRESS_STRING_NOPC from results87a
order by STAGE,parent_uprn,uprn;

--reset--

BEGIN
  FOR rec IN
    (
      SELECT
        table_name
      FROM
        all_tables
      WHERE
        table_name LIKE 'RESULTS%'
    )
  LOOP
    EXECUTE immediate 'DROP TABLE  '||rec.table_name || ' CASCADE CONSTRAINTS';
  END LOOP;
END;


--IGNORE BELOW 
-- ADD LAT N LONG
SELECT DISTINCT
    martir03.uprnseeding.id,
    martir03.uprnseeding.stage,
    martir03.uprnseeding.uprn,
    martir03.uprnseeding.parent_uprn,
    martir03.uprnseeding.address_string,
    martir03.uprnseeding.address_string_nopc,
    martir03.ad_base.latitude,
    martir03.ad_base.longitude
FROM
         martir03.uprnseeding
    LEFT JOIN martir03.ad_base ON martir03.uprnseeding.uprn = martir03.ad_base.uprn

SELECT DISTINCT ID FROM UPRNSEEDING

SELECT DISTINCT ID FROM  CHR_85__UPRNSEED

SELECT DISTINCT ID FROM UPRNSEEDING --618

SELECT DISTINCT ID FROM CI_UPRN_72_SEEDED


SELECT id, PARENT_UPRN  FROM CHR_85__UPRNSEED -- 1ST RUN TABLE
MINUS --GET U RECORDS IN 1ST RUN NOT IN 2ND - CHECK ERRORS ARE REMOVED.
SELECT  id, PARENT_UPRN FROM UPRNSEEDING -- UPDATE RIUN

SELECT id, PARENT_UPRN  FROM CHR_85__UPRNSEED 
INTERSECT -- IN BOTH
SELECT  id, PARENT_UPRN FROM UPRNSEEDING 

SELECT ID, PARENT_UPRN, ADDRESS_STRING,ADDRESS_STRING_NOPC,stage  AS CARE FROM CI_UPRN_72_SEEDED
MINUS
SELECT ID, PARENT_UPRN,  ADDRESS_STRING,ADDRESS_STRING_NOPC,stage AS AD_BASE FROM CI_UPRNSEEDING

SELECT DISTINCT ID FROM UNSEEDED  --101

SELECT DISTINCT ID FROM uprn_inc_names

SELECT TABLE_NAME FROM all_tables WHERE owner = 'MARTIR03' and table_name like 'RESULTS%' ;

CREATE TABLE stats AS SELECT table_name, num_rows as no_rows 
FROM all_tables WHERE owner = 'MARTIR03' and instr(table_name,'RESULTS',1,1)>0 AND NUM_ROWS>0;
--GENERATE STAGE MATCH COUNT FROM RESULTS UNION TABLE.
CREATE TABLE stats AS SELECT DISTINCT 
STAGE, 
COUNT( ID) OVER(PARTITION BY STAGE ORDER BY stage) AS COUNT_MATCHES
FROM UPRNSEEDING
ORDER BY STAGE;


drop table table_name like USER.'RESULTS%' ;
-